<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../../_static/javascripts/modernizr.js"></script>
  
  
  
    <title>pyremotedata.implicit_mount &#8212; PyRemoteData 0.0.36 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=83e35b93" />
    <link rel="stylesheet" type="text/css" href="../../_static/material.css?v=79c92029" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=fb6b2637" />
    <script src="../../_static/documentation_options.js?v=0e525676"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="canonical" href="_build/html/_modules/pyremotedata/implicit_mount.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=blue-grey data-md-color-accent=blue>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#_modules/pyremotedata/implicit_mount" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../index.html" title="PyRemoteData 0.0.36 documentation"
           class="md-header-nav__button md-logo">
          
            &nbsp;
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">PyRemoteData</span>
          <span class="md-header-nav__topic"> pyremotedata.implicit_mount </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder=""Search""
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://github.com/asgersvenning/pyremotedata" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    pyremotedata
  </div>
</a>
          </div>
        </div>
      
      
  
  <script src="../../_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = "../../"versions.json"",
        target_loc = "../../../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="../../index.html" class="md-tabs__link">PyRemoteData 0.0.36 documentation</a></li>
          <li class="md-tabs__item"><a href="../index.html" class="md-tabs__link">Module code</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../index.html" title="PyRemoteData 0.0.36 documentation" class="md-nav__button md-logo">
      
        <img src="../../_static/" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../../index.html"
       title="PyRemoteData 0.0.36 documentation">PyRemoteData</a>
  </label>
    <div class="md-nav__source">
      <a href="https://github.com/asgersvenning/pyremotedata" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    pyremotedata
  </div>
</a>
    </div>
  
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
  <ul class="md-nav__list" data-md-scrollfix="">
    

<li id="searchbox" class="md-nav__item"></li>

  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <h1 id="modules-pyremotedata-implicit-mount--page-root">Source code for pyremotedata.implicit_mount</h1><div class="highlight"><pre>
<span></span><span class="sd">"""</span>
<span class="sd">This module provides a pythonic interface for downloading files from a remote directory using the SFTP protocol.</span>

<span class="sd">The main functionality of this package is provided through the use of the ImplicitMount, IOHandler and RemotePathIterator classes:</span>

<span class="sd">* The **ImplicitMount** class provides a low-level wrapper for the LFTP shell, which is used to communicate with the remote directory, and should only be used directly by advanced users.</span>

<span class="sd">* The **IOHandler** class provides a high-level wrapper for the ImplicitMount class, which provides human-friendly methods for downloading files from a remote directory without the need to have technical knowledge on how to use LFTP.</span>

<span class="sd">* The **RemotePathIterator** class provides a high-level wrapper for the IOHandler class, and handles asynchronous streaming of files from a remote directory to a local directory using thread-safe buffers.</span>
<span class="sd">"""</span>

<span class="c1"># Standard library imports</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">shuffle</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># Threading and subprocess imports</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>

<span class="c1"># Internal import</span>
<span class="kn">from</span> <span class="nn">pyremotedata</span> <span class="kn">import</span> <span class="n">main_logger</span><span class="p">,</span> <span class="n">module_logger</span>
<span class="kn">from</span> <span class="nn">pyremotedata.config</span> <span class="kn">import</span> <span class="n">get_implicit_mount_config</span>

<div class="viewcode-block" id="ImplicitMount">
<a class="viewcode-back" href="../../ImplicitMount.html#pyremotedata.implicit_mount.ImplicitMount">[docs]</a>
<span class="k">class</span> <span class="nc">ImplicitMount</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This is a low-level wrapper of LFTP, which provides a pythonic interface for executing LFTP commands and reading the output.</span>
<span class="sd">    It provides a robust and efficient backend for communicating with a remote storage server using the SFTP protocol, using a persistent LFTP shell handled in the background by a subprocess.</span>
<span class="sd">    It is designed to be used as a base class for higher-level wrappers, such as the IOHandler class, or as a standalone class for users familiar with LFTP.</span>

<span class="sd">    OBS: The attributes of this method should not be used unless for development or advanced use cases, all responsibility in this case is on the user.</span>

<span class="sd">    TODO: This class relies on a proper SSH setup on your machine (and the remote server) for passwordless SFTP. </span>
<span class="sd">    Thoroughly test this on a fresh install, and add instructions, and the possibility for automatic setup, for setting up passwordless SFTP and SSH keys, as well as proper error handling for when this is not set up correctly.</span>

<span class="sd">    TODO: Add further arguments such as port, password, etc. to the constructor.</span>

<span class="sd">    Args:</span>
<span class="sd">        user (str): The username to use for connecting to the remote directory.</span>
<span class="sd">        remote (str): The remote server to connect to.</span>
<span class="sd">        verbose (bool): If True, print the commands executed by the class.</span>

<span class="sd">    .. &lt;Sphinx comment</span>
<span class="sd">    Methods:</span>
<span class="sd">        format_options(): Format a dictionary of options into a string of command line arguments.</span>
<span class="sd">        execute_command(): Execute a command on the LFTP shell.</span>
<span class="sd">        mount(): Mount the remote directory.</span>
<span class="sd">        unmount(): Unmount the remote directory.</span>
<span class="sd">        pget(): Download a single file from the remote directory using multiple connections.</span>
<span class="sd">        put(): Upload a single file to the remote directory.</span>
<span class="sd">        ls(): List the contents of a directory (on the remote). OBS: In contrast to the other LFTP commands, this function has a lot of additional functionality, such as recursive listing and caching.</span>
<span class="sd">        lls(): Locally list the contents of a directory.</span>
<span class="sd">        cd(): Change the current directory (on the remote).</span>
<span class="sd">        pwd(): Get the current directory (on the remote).</span>
<span class="sd">        lcd(): Change the current directory (locally).</span>
<span class="sd">        lpwd(): Get the current directory (locally).</span>
<span class="sd">        mirror(): Download a directory from the remote.</span>
<span class="sd">    .. Sphinx comment&gt;</span>
<span class="sd">    """</span>

    <span class="n">time_stamp_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">"^\s*(\S+\s+)</span><span class="si">{8}</span><span class="s2">"</span><span class="p">)</span> <span class="c1"># This is used to strip the timestamp from the output of the lftp shell</span>
    <span class="n">END_OF_OUTPUT</span> <span class="o">=</span> <span class="s1">'# LFTP_END_OF_OUTPUT_IDENTIFIER </span><span class="si">{uuid}</span><span class="s1"> #'</span>  <span class="c1"># This is used to signal the end of output when reading from stdout</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">remote</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="n">main_logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)):</span>
        <span class="c1"># Default argument configuration and type checking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span> <span class="o">=</span> <span class="n">get_implicit_mount_config</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">remote</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">remote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span><span class="p">[</span><span class="s1">'remote'</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Expected str, got </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">user</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Expected str, got </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">remote</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Expected bool, got </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">verbose</span><span class="p">)))</span>
        
        <span class="c1"># Set attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s2">""</span> <span class="c1"># Assume we use passwordless lftp (authentication is handled by ssh keys, not sftp)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote</span> <span class="o">=</span> <span class="n">remote</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stdout_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span> 

<div class="viewcode-block" id="ImplicitMount.format_options">
<a class="viewcode-back" href="../../ImplicitMount.html#pyremotedata.implicit_mount.ImplicitMount.format_options">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">format_options</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Takes a dictionary of options and formats them into a string of command line arguments suitable for LFTP.</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs: Keyword arguments to format.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The formatted arguments.</span>
<span class="sd">        """</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># main_logger.debug(f'key: |{key}|, value: |{value}|')</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">"-"</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">"--"</span>
            <span class="n">this_option</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">key</span><span class="si">}</span><span class="s2">"</span>
            
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="s2">""</span><span class="p">:</span>
                <span class="n">this_option</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
                
            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_option</span><span class="p">)</span>
            
        <span class="n">options</span> <span class="o">=</span> <span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">options</span></div>

    
    <span class="k">def</span> <span class="nf">_readerthread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">queue</span><span class="p">:</span> <span class="n">Queue</span><span class="p">):</span>  <span class="c1"># No longer static</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
                <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="k">def</span> <span class="nf">_read_stdout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">strip_timestamp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">uuid_str</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">EoU</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">END_OF_OUTPUT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">uuid_str</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">timeout</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">"Timeout while reading stdout"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">EoU</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">strip_timestamp</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_stamp_pattern</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="c1"># if not line.startswith("wait "):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_stderr</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">err</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">err</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"wait: no current job"</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Error while executing command: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>  <span class="c1"># Moved to the else clause</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="k">def</span> <span class="nf">_read_stderr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr_queue</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="k">return</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
    
<div class="viewcode-block" id="ImplicitMount.execute_command">
<a class="viewcode-back" href="../../ImplicitMount.html#pyremotedata.implicit_mount.ImplicitMount.execute_command">[docs]</a>
    <span class="k">def</span> <span class="nf">execute_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blocking</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">execute</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default_args</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Executes a command on the LFTP shell.</span>

<span class="sd">        Args:</span>
<span class="sd">            command (str): The command to execute.</span>
<span class="sd">            output (bool): If True, the function will return the output of the command. </span>
<span class="sd">            blocking (bool): If True, the function will block until the command is complete. If output is True, blocking must also be True.</span>
<span class="sd">            execute (bool): If True, the function will execute the command, otherwise it will return the command as a string.</span>
<span class="sd">            default_args (Union[dict, None]): A dictionary of default arguments to use for the command. If None, no default arguments will be used.</span>
<span class="sd">            **kwargs: Keyword arguments to pass to the command.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[str, List[str], None]: If execute is False, the function will return the command as a string. If output is True, returns a string, list or None depending of the number of output lines, otherwise returns None.</span>
<span class="sd">        """</span>
        <span class="c1"># Merge default arguments and keyword arguments. Keyword arguments will override default arguments.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default_args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">default_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Expected dict or None, got </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">default_args</span><span class="p">)))</span>
        
        <span class="c1"># Combine default arguments and keyword arguments</span>
        <span class="k">if</span> <span class="n">default_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">default_args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Remove optional "uuid_str" argument from kwargs</span>
        <span class="k">if</span> <span class="s2">"uuid_str"</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">uuid_str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"uuid_str"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uuid_str</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Combine default arguments and kwargs</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">default_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span> 
        
        <span class="c1"># Format arguments</span>
        <span class="n">formatted_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_options</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>

        <span class="c1"># Combine command and arguments</span>
        <span class="n">full_command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">formatted_args</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="n">formatted_args</span> <span class="k">else</span> <span class="n">command</span>
        <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">uuid_str</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">uuid_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blocking</span><span class="p">:</span>
            <span class="n">full_command</span> <span class="o">+=</span> <span class="s2">" &amp;"</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">full_command</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_command</span><span class="p">(</span><span class="n">full_command</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="n">blocking</span><span class="p">,</span> <span class="n">uuid_str</span><span class="o">=</span><span class="n">uuid_str</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">output</span>
            <span class="k">elif</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Expected list or None, got </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">output</span><span class="p">)))</span></div>


    <span class="k">def</span> <span class="nf">_execute_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blocking</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">uuid_str</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        ## DO NOT USE THIS FUNCTION DIRECTLY, USE `ImplicitMount.execute_command` INSTEAD.</span>

<span class="sd">        Executes a command on the LFTP shell.</span>

<span class="sd">        Args:</span>
<span class="sd">            command (str): The command to execute.</span>
<span class="sd">            output (bool): If True, the function will return the output of the command. </span>
<span class="sd">            blocking (bool): If True, the function will block until the command is complete. If output is True, blocking must also be True.</span>
<span class="sd">            uuid_str (str): A unique identifier for the command. Must be specified if output is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[List[str], None]: If output is True, the function will return a list of strings each containing one line of the output of the command, otherwise it will return None.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">output</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">blocking</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Non-blocking output is not supported."</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">uuid_str</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">blocking</span> <span class="ow">or</span> <span class="n">output</span><span class="p">):</span>
            <span class="n">uuid_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
            <span class="c1"># raise ValueError("uuid_str must be specified if output is True.")</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">command</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">):</span>
            <span class="n">command</span> <span class="o">+=</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span> 
            <span class="c1"># TODO: Is it safe to assume that the order of the output is the same as the order of the commands? Why is it "&lt;command&gt; &lt;end_of_output&gt; wait" and not "&lt;command&gt; wait &lt;end_of_output&gt;"?</span>
            <span class="c1">## Assemble command</span>
            <span class="c1"># Blocking and end of output logic</span>
            <span class="k">if</span> <span class="n">blocking</span> <span class="ow">or</span> <span class="n">output</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"echo </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">END_OF_OUTPUT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">uuid_str</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
            <span class="k">if</span> <span class="n">blocking</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">+=</span> <span class="s2">"wait</span><span class="se">\n</span><span class="s2">"</span>
            <span class="c1"># Execute command</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Executing command: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="c1"># Read output</span>
            <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_stdout</span><span class="p">(</span><span class="n">uuid_str</span><span class="o">=</span><span class="n">uuid_str</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">blocking</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_stdout</span><span class="p">(</span><span class="n">uuid_str</span><span class="o">=</span><span class="n">uuid_str</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="ImplicitMount.mount">
<a class="viewcode-back" href="../../ImplicitMount.html#pyremotedata.implicit_mount.ImplicitMount.mount">[docs]</a>
    <span class="k">def</span> <span class="nf">mount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lftp_settings</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Mount the remote directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            lftp_settings (Union[dict, None]): A dictionary of LFTP settings to use for mounting the remote directory. If None, the default settings will be used.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If the subprocess fails to start.</span>
<span class="sd">            RuntimeError: If the connection to the remote directory fails.</span>
<span class="sd">        """</span>
        <span class="c1"># set mirror:use-pget-n 5;set net:limit-rate 0;set xfer:parallel 5;set mirror:parallel-directories true;set ftp:sync-mode off;"</span>
        <span class="c1"># Merge default settings and user settings. User settings will override default settings.</span>
        <span class="n">lftp_settings</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">default_config</span><span class="p">[</span><span class="s1">'lftp'</span><span class="p">],</span> <span class="o">**</span><span class="n">lftp_settings</span><span class="p">}</span> <span class="k">if</span> <span class="n">lftp_settings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span><span class="p">[</span><span class="s1">'lftp'</span><span class="p">]</span>
        <span class="c1"># Format settings</span>
        <span class="n">lftp_settings_str</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">lftp_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">lftp_settings_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">" set </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">;"</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Mounting </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">remote</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="c1"># "Mount" the remote directory using an lftp shell with the sftp protocol and the specified user and remote, and the specified lftp settings</span>
        <span class="n">lftp_mount_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'open -u </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="si">}</span><span class="s1"> -p 2222 sftp://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">remote</span><span class="si">}</span><span class="s1">;</span><span class="si">{</span><span class="n">lftp_settings_str</span><span class="si">}</span><span class="s1">'</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Executing command: lftp"</span><span class="p">)</span>
        <span class="c1"># Start the lftp shell</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
                <span class="n">executable</span><span class="o">=</span><span class="s2">"lftp"</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">bufsize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># TODO: The exception should probably be a bit more specific</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Failed to start subprocess."</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="c1"># Start the stdout and stderr reader threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_readerthread</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout_queue</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_readerthread</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr_queue</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Set the threads as daemon threads so that they will be terminated when the main thread terminates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># Start the threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># Execute the mount command on the lftp shell (connect to the remote directory)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">lftp_mount_cmd</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_config</span><span class="p">[</span><span class="s1">'default_remote_dir'</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Waiting for connection..."</span><span class="p">)</span>
        <span class="c1"># Check if we are connected to the remote directory by executing the pwd command on the lftp shell</span>
        <span class="n">connected_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Connected to </span><span class="si">{</span><span class="n">connected_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">connected_path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unmount</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to connect. Check internet connection or if </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">remote</span><span class="si">}</span><span class="s2"> is online."</span><span class="p">)</span></div>


<div class="viewcode-block" id="ImplicitMount.unmount">
<a class="viewcode-back" href="../../ImplicitMount.html#pyremotedata.implicit_mount.ImplicitMount.unmount">[docs]</a>
    <span class="k">def</span> <span class="nf">unmount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Unmount the remote directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            timeout (float): The maximum time to wait for the lftp shell to terminate. If the timeout is exceeded, the lftp shell will be forcefully terminated.</span>
<span class="sd">        """</span>
        <span class="c1"># Close Popen streams explicitly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s2">"exit kill top"</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">waited</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">waited</span> <span class="o">+=</span> <span class="mf">0.1</span>
            <span class="k">if</span> <span class="n">waited</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImplicitMount.pget">
<a class="viewcode-back" href="../../ImplicitMount.html#pyremotedata.implicit_mount.ImplicitMount.pget">[docs]</a>
    <span class="k">def</span> <span class="nf">pget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">local_destination</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">blocking</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">execute</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Download a single file from the remote directory using the LFTP command `pget`.</span>

<span class="sd">        Args:</span>
<span class="sd">            remote_path (str): The remote file to download.</span>
<span class="sd">            local_destination (str): The local destination to download the file to.</span>
<span class="sd">            blocking (bool): If True, the function will block until the download is complete.</span>
<span class="sd">            execute (bool): If True, the function will execute the pget command, otherwise it will return the command as a string.</span>
<span class="sd">            output (Union[bool, None]): If True, the function will return the absolute local path of the downloaded file, otherwise it will return None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[None, str]: If output is True, the function will return the absolute local path of the downloaded file, otherwise it will return None.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">blocking</span>
        <span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'n'</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">default_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>
        <span class="n">formatted_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_options</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="n">full_command</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'pget </span><span class="si">{</span><span class="n">formatted_args</span><span class="si">}</span><span class="s1"> "</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s1">" -o "</span><span class="si">{</span><span class="n">local_destination</span><span class="si">}</span><span class="s1">"'</span>
        <span class="n">exec_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span>
            <span class="n">full_command</span><span class="p">,</span> 
            <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span> 
            <span class="n">blocking</span><span class="o">=</span><span class="n">blocking</span><span class="p">,</span>
            <span class="n">execute</span><span class="o">=</span><span class="n">execute</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">exec_output</span>
        
        <span class="c1"># Construct and return the absolute local path</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span>
        <span class="n">abs_local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">abs_local_path</span></div>

    
<div class="viewcode-block" id="ImplicitMount.put">
<a class="viewcode-back" href="../../ImplicitMount.html#pyremotedata.implicit_mount.ImplicitMount.put">[docs]</a>
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">remote_destination</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">blocking</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">execute</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Upload a single file to the remote directory using the LFTP command `put`.</span>

<span class="sd">        TODO: Is it really just a single file?</span>

<span class="sd">        Args:</span>
<span class="sd">            local_path (str): The local file to upload.</span>
<span class="sd">            remote_destination (str, optional): The remote destination to upload the file to. If None, the file will be uploaded to the current remote directory.</span>
<span class="sd">            blocking (bool): If True, the function will block until the upload is complete.</span>
<span class="sd">            execute (bool): If True, the function will execute the put command, otherwise it will return the command as a string.</span>
<span class="sd">            output (Union[bool, None]): If True, the function will return the absolute remote path of the uploaded file, otherwise it will return None.</span>
<span class="sd">            **kwargs: Keyword arguments to pass to the put command.</span>
<span class="sd">        """</span>
        <span class="k">def</span> <span class="nf">source_destination</span><span class="p">(</span><span class="n">local_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">remote_destination</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">local_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">local_path</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Expected list or str, got </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">local_path</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">remote_destination</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">remote_destination</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">local_path</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">remote_destination</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Expected list or str, got </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">local_path</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote_destination</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">remote_destination</span> <span class="o">=</span> <span class="p">[</span><span class="n">remote_destination</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote_destination</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Expected list or str, got </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">remote_destination</span><span class="p">)))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">remote_destination</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Expected local_path and remote_destination to have the same length, got </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2"> instead."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">local_path</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">remote_destination</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">remote_destination</span><span class="p">,</span> <span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">'"</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s1">" -o "</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s1">""'</span><span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">remote_destination</span><span class="p">)])</span>
        
        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">blocking</span>
        <span class="c1"># OBS: The online manual for LFTP is invalid for put (at least on ERDA); the included "P" option for the put command does not exist</span>
        <span class="n">default_args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">default_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>
        <span class="n">formatted_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_options</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="n">remote_destination</span><span class="p">,</span> <span class="n">src_to_dst</span> <span class="o">=</span> <span class="n">source_destination</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">remote_destination</span><span class="p">)</span>
        <span class="n">full_command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"put </span><span class="si">{</span><span class="n">formatted_args</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">src_to_dst</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">exec_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span>
            <span class="n">full_command</span><span class="p">,</span> 
            <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span> 
            <span class="n">blocking</span><span class="o">=</span><span class="n">blocking</span><span class="p">,</span>
            <span class="n">execute</span><span class="o">=</span><span class="n">execute</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">exec_output</span>
        
        <span class="c1"># Construct and return the absolute remote path</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">local_path</span><span class="p">))</span>
        <span class="n">rpwd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">()</span>
        <span class="n">abs_remote_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">rpwd</span> <span class="o">+</span> <span class="s2">"/"</span> <span class="o">+</span> <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">remote_destination</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">abs_remote_path</span></div>


<div class="viewcode-block" id="ImplicitMount.ls">
<a class="viewcode-back" href="../../ImplicitMount.html#pyremotedata.implicit_mount.ImplicitMount.ls">[docs]</a>
    <span class="k">def</span> <span class="nf">ls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"."</span><span class="p">,</span> <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_cache</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Find all files in the given remote directory using the LFTP command `cls`. Can be used recursively, even though LFTP does not support recursive listing with the `cls` command.</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str): The remote directory to search in.</span>
<span class="sd">            recursive (bool): If True, the function will search recursively.</span>
<span class="sd">            use_cache (bool): If True, the function will use `cls`, otherwise it will use `recls`. `recls` forces a refresh of the cache.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[None, str, List[str]]: If the directory is empty, the function will return None, if the directory contains one file, the function will return a string, otherwise it will return a list of strings.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">".."</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"ls does not support relative backtracing paths yet."</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"./"</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">path</span> <span class="o">==</span> <span class="s2">"."</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s2">""</span>
        
        <span class="c1"># This function is used to sanitize the output of the lftp shell</span>
        <span class="c1"># It is quite inefficient, but it is only used for the ls command, which is not performance critical?</span>
        <span class="c1"># Folder index files should be used instead of ls in most cases, </span>
        <span class="c1"># but this function is still useful for debugging and for creating the folder index files</span>
        <span class="k">def</span> <span class="nf">sanitize_path</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Empty case (base case 1)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># Single path case (base case 2)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="c1"># Skip "." and ".." paths and folder index files (these are created by the folder index command, and should be treated as hidden files)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s2">"folder_index.txt"</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                    <span class="c1"># Remove leading "./" from paths</span>
                    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"."</span><span class="p">):</span>
                        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                    <span class="c1"># Append path to list (this a mutative operation)</span>
                    <span class="n">l</span> <span class="o">+=</span> <span class="p">[</span><span class="n">path</span><span class="p">]</span>
            <span class="c1"># Multiple paths case (recursive case)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                    <span class="n">sanitize_path</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Expected list, str or None, got </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">l</span>
        
        <span class="c1"># Recursive ls is implemented by using the "cls" command, which returns a list of permissions and paths</span>
        <span class="c1"># and then recursively calling ls on each of the paths that are directories, </span>
        <span class="c1"># which is determined by checking if the permission starts with "d"</span>
        <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
            <span class="n">recls</span> <span class="o">=</span> <span class="s2">""</span> <span class="k">if</span> <span class="n">use_cache</span> <span class="k">else</span> <span class="s2">"re"</span>
            <span class="n">this_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">recls</span><span class="si">}</span><span class="s1">cls "</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">" -1 --perm'</span><span class="p">)</span>
            <span class="c1"># If the directory contains one or no files</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">this_level</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">this_level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">this_level</span> <span class="o">=</span> <span class="n">sanitize_path</span><span class="p">([],</span> <span class="n">this_level</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">perm_path</span> <span class="ow">in</span> <span class="n">this_level</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="s2">" "</span> <span class="ow">in</span> <span class="n">perm_path</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">perm</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">perm_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">perm</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"d"</span><span class="p">):</span>
                    <span class="n">output</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sanitize_path</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="c1"># Non-recursive case</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">sanitize_path</span><span class="p">([],</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="sa">f</span><span class="s1">'cls "</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">" -1'</span><span class="p">))</span>

        <span class="c1"># Check if the output is a list</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Expected list, got </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">output</span><span class="p">)))</span>
        
        <span class="k">return</span> <span class="n">output</span></div>

    
<div class="viewcode-block" id="ImplicitMount.lls">
<a class="viewcode-back" href="../../ImplicitMount.html#pyremotedata.implicit_mount.ImplicitMount.lls">[docs]</a>
    <span class="k">def</span> <span class="nf">lls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Find all files in the given local directory using the LFTP command `!ls` or `!find`.</span>

<span class="sd">        OBS: This function should probably not be used, just use the standard OS commands instead.</span>
<span class="sd">        """</span>
        <span class="n">recursive</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"R"</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"recursive"</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">local_path</span> <span class="o">==</span> <span class="s2">""</span><span class="p">:</span>
                <span class="n">local_path</span> <span class="o">=</span> <span class="s2">"."</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="sa">f</span><span class="s1">'!find "</span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s1">" -type f -exec realpath --relative-to="</span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s1">" </span><span class="se">{{}}</span><span class="s1"> </span><span class="se">\\</span><span class="s1">;'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="sa">f</span><span class="s1">'!ls "</span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s1">"'</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="c1"># Check if the output is a list</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Expected list, got </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">output</span><span class="p">)))</span>
        
        <span class="k">return</span> <span class="n">output</span></div>


    <span class="k">def</span> <span class="nf">cd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="sa">f</span><span class="s1">'cd "</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s1">"'</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ImplicitMount.pwd">
<a class="viewcode-back" href="../../ImplicitMount.html#pyremotedata.implicit_mount.ImplicitMount.pwd">[docs]</a>
    <span class="k">def</span> <span class="nf">pwd</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Get the current remote directory using the LFTP command `pwd`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The current remote directory.</span>
<span class="sd">        """</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s2">"pwd"</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Expected list of length 1, got </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="n">output</span><span class="p">))</span></div>


<div class="viewcode-block" id="ImplicitMount.lcd">
<a class="viewcode-back" href="../../ImplicitMount.html#pyremotedata.implicit_mount.ImplicitMount.lcd">[docs]</a>
    <span class="k">def</span> <span class="nf">lcd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Changes the current local directory using the LFTP command `lcd`.</span>

<span class="sd">        Args:</span>
<span class="sd">            local_path (str): The local directory to change to.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">"lcd </span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="ImplicitMount.lpwd">
<a class="viewcode-back" href="../../ImplicitMount.html#pyremotedata.implicit_mount.ImplicitMount.lpwd">[docs]</a>
    <span class="k">def</span> <span class="nf">lpwd</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Get the current local directory using the LFTP command `lpwd`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The current local directory.</span>
<span class="sd">        """</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s2">"lpwd"</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Expected list of length 1, got </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="n">output</span><span class="p">))</span></div>

    
    <span class="k">def</span> <span class="nf">_get_current_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lls</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="s2">""</span><span class="p">)</span>

<div class="viewcode-block" id="ImplicitMount.mirror">
<a class="viewcode-back" href="../../ImplicitMount.html#pyremotedata.implicit_mount.ImplicitMount.mirror">[docs]</a>
    <span class="k">def</span> <span class="nf">mirror</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">local_destination</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">blocking</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">execute</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_return</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Download a directory from the remote directory to the given local destination using the LFTP mirror command.</span>

<span class="sd">        Args:</span>
<span class="sd">            remote_path (str): The remote directory to download.</span>
<span class="sd">            local_destination (str): The local destination to download the directory to.</span>
<span class="sd">            blocking (bool): If True, the function will block until the download is complete.</span>
<span class="sd">            execute (bool): If True, the function will execute the mirror command, otherwise it will return the command as a string.</span>
<span class="sd">            do_return (bool): If True, the function will return a list of the newly downloaded files.</span>
<span class="sd">            **kwargs: Keyword arguments to pass to the mirror command.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[None, List[str]]: If do_return is True, the function will return a list of the newly downloaded files, otherwise it will return None.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">do_return</span><span class="p">:</span>
            <span class="c1"># Capture the state of the directory before the operation</span>
            <span class="n">pre_existing_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_current_files</span><span class="p">(</span><span class="n">local_destination</span><span class="p">)</span>
            <span class="c1"># Ensure that the pre_existing_files list is unique</span>
            <span class="n">pre_existing_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pre_existing_files</span><span class="p">)</span>

        <span class="c1"># Execute the mirror command</span>
        <span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'P'</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">'use-cache'</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="n">exec_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">'mirror "</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s1">" "</span><span class="si">{</span><span class="n">local_destination</span><span class="si">}</span><span class="s1">"'</span><span class="p">,</span> 
            <span class="n">output</span><span class="o">=</span><span class="n">blocking</span><span class="p">,</span> 
            <span class="n">blocking</span><span class="o">=</span><span class="n">blocking</span><span class="p">,</span> 
            <span class="n">execute</span><span class="o">=</span><span class="n">execute</span><span class="p">,</span>
            <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">,</span> 
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">exec_output</span>
        
        <span class="k">if</span> <span class="n">do_return</span><span class="p">:</span>
            <span class="c1"># Capture the state of the directory after the operation</span>
            <span class="n">post_download_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_current_files</span><span class="p">(</span><span class="n">local_destination</span><span class="p">)</span>
            <span class="c1"># Ensure that the post_download_files list is unique</span>
            <span class="n">post_download_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">post_download_files</span><span class="p">)</span>

            <span class="c1"># Calculate the set difference to get the newly downloaded files</span>
            <span class="n">new_files</span> <span class="o">=</span> <span class="n">post_download_files</span> <span class="o">-</span> <span class="n">pre_existing_files</span>
            
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_files</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>
</div>


<div class="viewcode-block" id="IOHandler">
<a class="viewcode-back" href="../../IOHandler.html#pyremotedata.implicit_mount.IOHandler">[docs]</a>
<span class="k">class</span> <span class="nc">IOHandler</span><span class="p">(</span><span class="n">ImplicitMount</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This is a high-level wrapper for the ImplicitMount class, which provides human-friendly methods for downloading files from a remote directory without the need to have technical knowledge on how to use LFTP.</span>

<span class="sd">    OBS: The attributes of this method should not be used unless for development or advanced use cases, all responsibility in this case is on the user.</span>

<span class="sd">    Args:</span>
<span class="sd">        local_dir (str): The local directory to use for downloading files. If None, a temporary directory will be used (suggested, unless truly necessary).</span>
<span class="sd">        user_confirmation (bool): If True, the user will be asked for confirmation before deleting files. (strongly suggested for debugging and testing)</span>
<span class="sd">        clean (bool): If True, the local directory will be cleaned after the context manager is exited. (suggested, if not it may lead to rapid exhaustion of disk space)</span>
<span class="sd">        **kwargs: Keyword arguments to pass to the ImplicitMount constructor.</span>

<span class="sd">    .. &lt;Sphinx comment</span>
<span class="sd">    Methods:</span>
<span class="sd">        download(): Download the given remote path to the given local destination.</span>
<span class="sd">        multi_download(): Download the given remote paths to the given local destinations.</span>
<span class="sd">        clone(): Clone the current remote directory to the given local destination.</span>
<span class="sd">        get_file_index(): Get a list of files in the current directory.</span>
<span class="sd">        cache_file_index(): Cache the file index for the current directory.</span>
<span class="sd">        store_last(): TODO: NOT IMPLEMENTED! Move the last downloaded file or directory to the given destination.</span>
<span class="sd">        clean(): Clean the local directory.</span>
<span class="sd">        clean_last(): Clean the last downloaded file or directory.</span>
<span class="sd">    .. Sphinx comment&gt;</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_dir</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user_confirmation</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clean</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">local_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span><span class="p">[</span><span class="s1">'local_dir'</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">local_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">local_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span><span class="p">[</span><span class="s1">'local_dir'</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">local_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_local_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">local_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_dir</span> <span class="o">=</span> <span class="n">local_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_confirmation</span> <span class="o">=</span> <span class="n">user_confirmation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_clean</span> <span class="o">=</span> <span class="n">clean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_download</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"IOHandler"</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mount</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_dir</span><span class="p">)</span>

        <span class="c1"># Print local directory:</span>
        <span class="c1"># if the local directory is not specified in the config, </span>
        <span class="c1"># it is a temporary directory, so it is nice to know where it is located</span>
        <span class="n">main_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Local directory: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Return self</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Positional and keyword arguments simply catch any arguments passed to the function to be ignored</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_clean</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unmount</span><span class="p">()</span>

    <span class="c1"># Methods for using the IOHandler without context management</span>
<div class="viewcode-block" id="IOHandler.start">
<a class="viewcode-back" href="../../IOHandler.html#pyremotedata.implicit_mount.IOHandler.start">[docs]</a>
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Initialize the connection to the remote directory.</span>

<span class="sd">        Very useful for interactive use, but shouldn't be used in scripts, using a context manager is safer and does the same.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>

        <span class="n">main_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"IOHandler.start() is unsafe. Use IOHandler.__enter__() instead if possible."</span><span class="p">)</span>
        <span class="n">main_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"OBS: Remember to call IOHandler.stop() when you are done."</span><span class="p">)</span></div>


<div class="viewcode-block" id="IOHandler.stop">
<a class="viewcode-back" href="../../IOHandler.html#pyremotedata.implicit_mount.IOHandler.stop">[docs]</a>
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Close the connection to the remote directory.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">()</span></div>


<div class="viewcode-block" id="IOHandler.download">
<a class="viewcode-back" href="../../IOHandler.html#pyremotedata.implicit_mount.IOHandler.download">[docs]</a>
    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">local_destination</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">blocking</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Downloads one or more files or a directory from the remote directory to the given local destination.</span>

<span class="sd">        Args:</span>
<span class="sd">            remote_path (Union[str, List[str]]): The remote path(s) to download.</span>
<span class="sd">            local_destination (Union[str, List[str]]): The local destination to download the file(s) to. If None, the file(s) will be downloaded to the current local directory.</span>
<span class="sd">            blocking (bool): If True, the function will block until the download is complete.</span>
<span class="sd">            **kwargs: Extra keyword arguments are passed to the IOHandler.multi_download, IOHandler.pget or IOHandler.mirror functions depending on the type of the remote path(s).</span>

<span class="sd">        Returns:</span>
<span class="sd">            (List of) The local path of the downloaded file(s) or directory.</span>
<span class="sd">        """</span>
        <span class="c1"># If multiple remote paths are specified, use multi_download instead of download, </span>
        <span class="c1"># this function is more flexible than mirror (works for files from different directories) and much faster than executing multiple pget commands</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_download</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">local_destination</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">remote_path</span> <span class="o">=</span> <span class="n">remote_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Expected str, got </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)))</span>
        
        <span class="k">if</span> <span class="n">local_destination</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">local_destination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">()</span>

        <span class="c1"># Check if remote and local have file extensions:</span>
        <span class="c1"># The function assumes files have extensions and directories do not.</span>
        <span class="n">remote_has_ext</span><span class="p">,</span> <span class="n">local_has_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">""</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">local_destination</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">""</span>
        <span class="c1"># If both remote and local have file extensions, the local destination should be a file path.</span>
        <span class="k">if</span> <span class="n">remote_has_ext</span> <span class="ow">and</span> <span class="n">local_has_ext</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">local_destination</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Destination must be a file path if both remote and local have file extensions."</span><span class="p">)</span>
        <span class="c1"># If the remote does not have a file extension, the local destination should be a directory.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">remote_has_ext</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">local_destination</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Destination must be a directory if remote does not have a file extension."</span><span class="p">)</span>
        
        <span class="c1"># Download cases;</span>
        <span class="c1"># If the remote is a single file, use pget.</span>
        <span class="k">if</span> <span class="n">remote_has_ext</span><span class="p">:</span>
            <span class="n">local_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pget</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">local_destination</span><span class="p">,</span> <span class="n">blocking</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_type</span> <span class="o">=</span> <span class="s2">"file"</span>
        <span class="c1"># Otherwise use mirror.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_destination</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">local_destination</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">local_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mirror</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">local_destination</span><span class="p">,</span> <span class="n">blocking</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_type</span> <span class="o">=</span> <span class="s2">"directory"</span>
        
        <span class="c1"># TODO: Check local_result == local_destination (if it can be done in a relatively efficient way)</span>

        <span class="c1"># Store the last download for later use (nice for debugging)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_download</span> <span class="o">=</span> <span class="n">local_result</span>
        <span class="c1"># Return the local path of the downloaded file or directory</span>
        <span class="k">return</span> <span class="n">local_result</span></div>

    
<div class="viewcode-block" id="IOHandler.multi_download">
<a class="viewcode-back" href="../../IOHandler.html#pyremotedata.implicit_mount.IOHandler.multi_download">[docs]</a>
    <span class="k">def</span> <span class="nf">multi_download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">local_destination</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">blocking</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Downloads a list of files from the remote directory to the given local destination.</span>

<span class="sd">        Args:</span>
<span class="sd">            remote_paths (List[str]): A list of remote paths to download.</span>
<span class="sd">            local_destination (Union[str, List[str]]): The local destination to download the files to. If None, the files will be downloaded to the current local directory.</span>
<span class="sd">            blocking (bool): If True, the function will block until the download is complete.</span>
<span class="sd">            n (int): The number of connections to use for downloading each file.</span>
<span class="sd">            **kwargs: Extra keyword arguments are ignored.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            A list of the local paths of the downloaded files.</span>
<span class="sd">        """</span>
        <span class="c1"># TODO: This function should really wrap an IOHandler.mget function, which should be implemented in the ImplicitMount class</span>
        <span class="c1"># Type checking and default argument configuration</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote_paths</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Expected list, got </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">remote_paths</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="n">local_destination</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Expected str or list, got </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">local_destination</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">local_destination</span> <span class="o">=</span> <span class="p">[</span><span class="n">local_destination</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">remote_paths</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">local_destination</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">local_destination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">()</span>
            <span class="n">local_destination</span> <span class="o">=</span> <span class="p">[</span><span class="n">local_destination</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">remote_paths</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remote_paths</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">local_destination</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"remote_paths and local_destination must have the same length."</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">l</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">r</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="n">remote_paths</span><span class="p">)]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Local and remote file extensions must match."</span><span class="p">)</span>
        
        <span class="c1"># Assemble the mget command, options and arguments</span>
        <span class="n">multi_command</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'mget -P </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1"> '</span> <span class="o">+</span> <span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">'"</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s1">"'</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">remote_paths</span><span class="p">])</span>
        <span class="c1"># Execute the mget command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">multi_command</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">blocking</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="n">blocking</span><span class="p">)</span>
        <span class="c1"># Check if the files were downloaded TODO: is this too slow? Should we just assume that the files were downloaded for efficiency?</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">local_destination</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to download </span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Store the last download for later use (nice for debugging)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_download</span> <span class="o">=</span> <span class="n">local_destination</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_type</span> <span class="o">=</span> <span class="s2">"multi"</span>
        <span class="c1"># Return the local paths of the downloaded files</span>
        <span class="k">return</span> <span class="n">local_destination</span></div>


<div class="viewcode-block" id="IOHandler.clone">
<a class="viewcode-back" href="../../IOHandler.html#pyremotedata.implicit_mount.IOHandler.clone">[docs]</a>
    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_destination</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">blocking</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Clones the current remote directory to the given local destination.</span>

<span class="sd">        Args:</span>
<span class="sd">            local_destination (str): The local destination to clone the current remote directory to.</span>
<span class="sd">            blocking (bool): If True, the function will block until the download is complete.</span>
<span class="sd">            **kwargs: Keyword arguments to pass to the mirror function.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            The output of ImplicitMount.mirror, which depend on the arguments passed to the function. Most likely a list of the newly downloaded files.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">local_destination</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Expected str or None, got </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">local_destination</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">local_destination</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">local_destination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">()</span>
        <span class="n">local_destination</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">local_destination</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_destination</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">local_destination</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mirror</span><span class="p">(</span><span class="s2">"."</span><span class="p">,</span> <span class="n">local_destination</span><span class="p">,</span> <span class="n">blocking</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="IOHandler.get_file_index">
<a class="viewcode-back" href="../../IOHandler.html#pyremotedata.implicit_mount.IOHandler.get_file_index">[docs]</a>
    <span class="k">def</span> <span class="nf">get_file_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nmax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">override</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pattern</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span><span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Get a list of files in the current remote directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            skip (int): The number of files to skip.</span>
<span class="sd">            nmax (int): The maximum number of files to include.</span>
<span class="sd">            override (bool): If True, the file index will be overridden if it already exists.</span>
<span class="sd">            store (bool): If True, the file index will be stored on the remote directory.</span>
<span class="sd">            pattern (str): A regular expression pattern to filter the file names by, e.g. "\\.txt$" to only include files with the ".txt" extension.</span>
<span class="sd">        Returns:</span>
<span class="sd">            A list of files in the current remote directory.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">override</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">store</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"override cannot be 'True' if store is 'False'!"</span><span class="p">)</span>
        <span class="c1"># Check if file index exists</span>
        <span class="n">file_index_exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s1">'glob -f --exist *folder_index.txt &amp;&amp; echo "YES" || echo "NO"'</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"YES"</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_index_exists</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">main_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Folder index does not exist in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="c1"># If override is True, delete the file index if it exists</span>
        <span class="k">if</span> <span class="n">override</span> <span class="ow">and</span> <span class="n">file_index_exists</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">store</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"'override' is '</span><span class="si">{</span><span class="n">override</span><span class="si">}</span><span class="s2">' and 'store' is '</span><span class="si">{</span><span class="n">store</span><span class="si">}</span><span class="s2">', this is not allowed and should not happen!"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s2">"rm folder_index.txt"</span><span class="p">)</span>
            <span class="c1"># Now the file index does not exist (duh)</span>
            <span class="n">file_index_exists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># If the file index does not exist, create it</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_index_exists</span><span class="p">:</span>
            <span class="n">main_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"Creating folder index..."</span><span class="p">)</span>
            <span class="c1"># Traverse the remote directory and write the file index to a file</span>
            <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">local_index_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">()</span><span class="si">}</span><span class="s2">folder_index.txt"</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_index_path</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
            <span class="c1"># Store the file index on the remote if 'store' is True, otherwise delete it</span>
            <span class="k">if</span> <span class="n">store</span><span class="p">:</span>
                <span class="c1"># Self has an implicit reference to the local working directory, however the scripts does not necessarily have the same working directory</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"folder_index.txt"</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">local_index_path</span><span class="p">)</span>
        
        <span class="c1"># Download the file index if 'store' is True or it already exists on the remote, otherwise read it from the local directory</span>
        <span class="k">if</span> <span class="n">store</span> <span class="ow">or</span> <span class="n">file_index_exists</span><span class="p">:</span>
            <span class="n">file_index_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">"folder_index.txt"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_index_path</span> <span class="o">=</span> <span class="n">local_index_path</span>
        <span class="c1"># Read the file index</span>
        <span class="n">file_index</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_index_path</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skip</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">nmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">skip</span> <span class="o">+</span> <span class="n">nmax</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="s2">"folder_index.txt"</span> <span class="o">==</span> <span class="n">line</span><span class="p">[:</span><span class="mi">16</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">pattern</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">file_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="c1"># Delete the file index if 'store' is True, otherwise return the path to the file index</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">store</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_index_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">file_index</span></div>

    
    <span class="k">def</span> <span class="nf">cache_file_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nmax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">override</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="s2">"file_index"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_file_index</span><span class="p">(</span><span class="n">skip</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span> <span class="n">override</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_confirmation</span><span class="p">:</span>
            <span class="c1"># Ask for confirmation</span>
            <span class="n">confirmation</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Are you sure you want to delete all files in the current directory </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">()</span><span class="si">}</span><span class="s2">? (y/n)"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">confirmation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">"y"</span><span class="p">:</span>
                <span class="n">main_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"Aborted"</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="n">main_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"Cleaning up..."</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">main_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"Error"</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">main_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Error while cleaning local backend directory!"</span><span class="p">)</span>
            <span class="n">files_in_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">files_in_dir</span><span class="p">:</span>
                <span class="n">n_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files_in_dir</span><span class="p">)</span>
                <span class="n">main_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">n_files</span><span class="si">}</span><span class="s2"> files in local directory (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">()</span><span class="si">}</span><span class="s2">):"</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n_files</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">main_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n\t</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">files_in_dir</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n\t</span><span class="s2">..."</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">main_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n\t</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">files_in_dir</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">e</span></div>


<div class="viewcode-block" id="RemotePathIterator">
<a class="viewcode-back" href="../../RemotePathIterator.html#pyremotedata.implicit_mount.RemotePathIterator">[docs]</a>
<span class="k">class</span> <span class="nc">RemotePathIterator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This function provides a high-level buffered iterator for downloading files from a remote directory.</span>
<span class="sd">    All heavy computation is done in a separate thread, to avoid blocking the main thread unnecessarily.</span>

<span class="sd">    OBS: The attributes of this method should not be used unless for development or advanced use cases, all responsibility in this case is on the user.</span>

<span class="sd">    Args:</span>
<span class="sd">        io_handler (IOHandler): A backend object of class "IOHandler" to use for downloading files.</span>
<span class="sd">        batch_size (int): The number of files to download in each batch. Larger batches are more efficient, but may cause memory issues.</span>
<span class="sd">        batch_parallel (int): The number of files to download in parallel in each batch. Larger values may be more efficient, but can cause excessive loads on the remote server.</span>
<span class="sd">        max_queued_batches (int): The batches are processed sequentially from a queue, which is filled on request. This parameter specifies the maximum number of batches in the queue. Larger values can ensure a stable streaming rate, but may require more files to be stored locally.</span>
<span class="sd">        n_local_files (int): The number of files to store locally. OBS: This MUST be larger than batch_size * max_queued_batches (I suggest twice that), otherwise files may be deleted before they are consumed. </span>
<span class="sd">        clear_local (bool): If True, the local directory will be cleared after the iterator is stopped.</span>
<span class="sd">        **kwargs: Keyword arguments to pass to the IOHandler.get_file_index() function. Set 'store' to False to avoid altering the remote directory (this is much slower if you intent to use the iterator multiple times, however it may be necessary if the remote directory is read-only). PSA: If 'store' is False, 'override' must also be False.</span>

<span class="sd">    Yields:</span>
<span class="sd">        Tuple[str, str]: A tuple containing the local path and the remote path of the downloaded file.</span>

<span class="sd">    .. &lt;Sphinx comment</span>
<span class="sd">    Methods:</span>
<span class="sd">        shuffle(): Shuffle the remote paths.</span>
<span class="sd">        subset(): Subset the remote paths.</span>
<span class="sd">        split(): Split the remote paths into multiple iterators, that share the same backend. These CANNOT be used in parallel. TODO: Can they be used concurrently?</span>
<span class="sd">        download_files(): Download files in batches.</span>
<span class="sd">    .. Sphinx comment&gt; </span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">io_handler</span><span class="p">:</span> <span class="s2">"IOHandler"</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">batch_parallel</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_queued_batches</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_local_files</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="mi">64</span><span class="p">,</span> <span class="n">clear_local</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io_handler</span> <span class="o">=</span> <span class="n">io_handler</span>
        <span class="k">if</span> <span class="s2">"file_index"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">io_handler</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io_handler</span><span class="o">.</span><span class="n">get_file_index</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">main_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Using cached file index. [</span><span class="si">{</span><span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1">] will be ignored.'</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io_handler</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="s2">"file_index"</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io_handler</span><span class="o">.</span><span class="n">lpwd</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_parallel</span> <span class="o">=</span> <span class="n">batch_parallel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_queued_batches</span> <span class="o">=</span> <span class="n">max_queued_batches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_local_files</span> <span class="o">=</span> <span class="n">n_local_files</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_local_files</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
            <span class="n">main_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"n_local_files (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_local_files</span><span class="si">}</span><span class="s2">) is less than batch_size (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">). This may cause files to be deleted before they are consumed. Consider increasing n_local_files. Recommended value: </span><span class="si">{</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">max_queued_batches</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">download_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_requested</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">not_cleaned</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_local</span> <span class="o">=</span> <span class="n">clear_local</span>

        <span class="c1"># State variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_item</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_batch_consumed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consumed_files</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="RemotePathIterator.shuffle">
<a class="viewcode-back" href="../../RemotePathIterator.html#pyremotedata.implicit_mount.RemotePathIterator.shuffle">[docs]</a>
    <span class="k">def</span> <span class="nf">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Shuffle the remote paths.</span>

<span class="sd">        Shuffles the remote paths in-place. This function should not be called while iterating.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"Cannot shuffle while iterating."</span><span class="p">)</span>
        <span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span><span class="p">)</span></div>


<div class="viewcode-block" id="RemotePathIterator.subset">
<a class="viewcode-back" href="../../RemotePathIterator.html#pyremotedata.implicit_mount.RemotePathIterator.subset">[docs]</a>
    <span class="k">def</span> <span class="nf">subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Subset the remote paths.</span>

<span class="sd">        Subsets the remote paths in-place. This function should not be called while iterating.</span>

<span class="sd">        Args:</span>
<span class="sd">            indices (List[int]): A list of indices to keep.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"Cannot subset while iterating."</span><span class="p">)</span>
        <span class="c1"># TODO: It is fine that this works with a list of indices, but it should also work with a single index or a slice.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span></div>


<div class="viewcode-block" id="RemotePathIterator.split">
<a class="viewcode-back" href="../../RemotePathIterator.html#pyremotedata.implicit_mount.RemotePathIterator.split">[docs]</a>
    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proportion</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">"RemotePathIterator"</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Split the remote paths into multiple iterators, that share the same backend. These CANNOT be used in parallel. </span>

<span class="sd">        Either, but not both, of proportion and indices must be specified.</span>

<span class="sd">        Args:</span>
<span class="sd">            proportion (Union[float, None]): A list of proportions to split the remote paths into. If None, indices must be specified.</span>
<span class="sd">            indices (Union[List[List[int]], None]): A list of lists of indices to split the remote paths into. If None, proportion must be specified.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[RemotePathIterator]: A list of RemotePathIterator objects.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"Cannot split while iterating."</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proportion</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Either proportion or indices must be specified."</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proportion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Only one of proportion or indices must be specified."</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proportion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proportion</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"proportion must be a list."</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">proportion</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"All proportions must be floats."</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">proportion</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"All proportions must be between 0 and 1."</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">proportion</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">proportion</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">proportion</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">proportion</span><span class="p">]</span>
            <span class="c1"># Assume we have the correct imports from random already</span>
            <span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choices</span><span class="p">,</span> <span class="n">choice</span>
            <span class="n">allocation</span> <span class="o">=</span> <span class="n">choices</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proportion</span><span class="p">))),</span> <span class="n">weights</span><span class="o">=</span><span class="n">proportion</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span><span class="p">))</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proportion</span><span class="p">))]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">allocation</span><span class="p">):</span>
                <span class="n">indices</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"indices must be a list."</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"indices must be a list of lists."</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"indices must be a list of lists of ints."</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">any</span><span class="p">([</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"indices must be a list of lists of ints in the range [0, len(remote_paths))."</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"All indices must be non-empty."</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"This should never happen."</span><span class="p">)</span>
            
        <span class="n">iterators</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="n">this</span> <span class="o">=</span> <span class="n">RemotePathIterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io_handler</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">batch_parallel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_parallel</span><span class="p">,</span> <span class="n">max_queued_batches</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_queued_batches</span><span class="p">,</span> <span class="n">n_local_files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_local_files</span><span class="p">)</span>
            <span class="n">this</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">iterators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">iterators</span></div>


<div class="viewcode-block" id="RemotePathIterator.download_files">
<a class="viewcode-back" href="../../RemotePathIterator.html#pyremotedata.implicit_mount.RemotePathIterator.download_files">[docs]</a>
    <span class="k">def</span> <span class="nf">download_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Download the entire list of remote paths in batches, and stores the local paths in a queue (self.download_queue).</span>

<span class="sd">        The function is not intended to be called directly, but there is no good reason why it should not and useful for debugging and testing.</span>
<span class="sd">        """</span>
        <span class="n">queued_batches</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_requested</span><span class="p">:</span>
                <span class="k">break</span>
                
            <span class="k">while</span> <span class="n">queued_batches</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_queued_batches</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_requested</span><span class="p">:</span>
                <span class="c1"># Wait until a batch has been consumed (or multiple batches, if the consumer is fast and the producer is slow) before downloading another batch</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_batch_consumed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_batch_consumed</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">break</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># Wait until a batch has been consumed</span>

            <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">local_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io_handler</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_parallel</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">main_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to download batch </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">main_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"Skipping batch..."</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">local_path</span><span class="p">,</span> <span class="n">remote_path</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">local_paths</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">download_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">local_path</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">))</span>
                
            <span class="n">queued_batches</span> <span class="o">+=</span> <span class="mi">1</span></div>

            
            <span class="c1"># Deletion logic moved to __next__ to maintain minimal queued files</span>

<div class="viewcode-block" id="RemotePathIterator.start_download_queue">
<a class="viewcode-back" href="../../RemotePathIterator.html#pyremotedata.implicit_mount.RemotePathIterator.start_download_queue">[docs]</a>
    <span class="k">def</span> <span class="nf">start_download_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Creates a new thread and call the self.download_files() function in the new thread.</span>

<span class="sd">        Ensures non-blocking download of the files in self.remote_paths.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">download_files</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"RemotePathIterator"</span><span class="p">:</span>
        <span class="c1"># Force reset state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">not_cleaned</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__del__</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Prepare state for iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_requested</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">not_cleaned</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># Start the download thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_download_queue</span><span class="p">()</span>

        <span class="c1"># Return self</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Returns: </span>
<span class="sd">            Tuple[str, str]: Tuple of the local path and the remote path.</span>
<span class="sd">        """</span>
        <span class="c1"># Handle stop request and end of iteration</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_requested</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_local</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="fm">__del__</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_requested</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>

        <span class="c1"># Delete files if the queue is too large</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_queue</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_local_files</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delete_queue</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">main_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to remove file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Get next item from queue or raise error if queue is empty</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">next_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="c1"># Timeout not applicable, since there is no guarantees on the size of the files or the speed of the connection</span>
            <span class="c1"># Update state to ensure that the producer keeps the queue prefilled</span>
            <span class="c1"># It is a bit complicated because the logic must be able to handle the case where the consumer is faster than the producer,</span>
            <span class="c1"># in this case the producer may be multiple batches behind the consumer.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">consumed_files</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumed_files</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">consumed_files</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_batch_consumed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span> <span class="c1"># TODO: Can this happen?</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_requested</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="fm">__del__</span><span class="p">()</span>
                <span class="k">raise</span> <span class="ne">StopIteration</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"Download queue is empty but no stop was requested. Check the download thread."</span><span class="p">)</span>

        <span class="c1"># Update state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">next_item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="c1"># Return next item (local path, remote path =&gt; can be parsed to get the class label)</span>
        <span class="k">return</span> <span class="n">next_item</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_cleaned</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="c1"># Force the iterator to stop if it is not already stopped</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_requested</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Wait for the download thread to finish</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Clean up the temporary directory</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">main_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to remove file (</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_local</span><span class="p">:</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">main_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to remove file (</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_queue</span><span class="o">.</span><span class="n">mutex</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delete_queue</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            
            <span class="c1"># Remove any remaining files in the temporary directory</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">"folder_index.txt"</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">main_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to remove file: </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                    <span class="k">pass</span>

            <span class="c1">## TODO: DOUBLE CHECK - THIS SHOULD NOT BE NECESSARY (it is at the moment though!)</span>
            <span class="c1"># Check if the download thread is still running</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">main_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Download thread is still running. This should not happen."</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop_requested</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Check if the download queue is empty</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                <span class="n">main_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Download queue is not empty. This should not happen."</span><span class="p">)</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_queue</span><span class="o">.</span><span class="n">mutex</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">download_queue</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="c1"># Check if the delete queue is empty</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_local</span><span class="p">:</span>
                <span class="n">main_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Delete queue is not empty. This should not happen."</span><span class="p">)</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_queue</span><span class="o">.</span><span class="n">mutex</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">download_queue</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">main_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"Already cleaned up"</span><span class="p">)</span></div>

</pre></div>

          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2024, Asger Svenning.
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>