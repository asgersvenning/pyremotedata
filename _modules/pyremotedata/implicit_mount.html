


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../_static/favicon.ico">
    
    
      
        <title>pyremotedata.implicit_mount - PyRemoteData 0.1.4 documentation</title>
      
    
    
      
        
      
      


    
    
      
    
    
      
        
        
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
        <link rel="stylesheet" type="text/css" href="../../_static/sphinx_immaterial_theme.acf80fe7f4d9ef9e2.min.css?v=9e56d0d2" />
        <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=f5981529" />
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="light-blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../index.html" title="PyRemoteData 0.1.4 documentation" class="md-header__button md-logo" aria-label="PyRemoteData 0.1.4 documentation" data-md-component="logo">
      <img src="../../_static/cloud_sync.svg" alt="logo">
    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PyRemoteData 0.1.4 documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              pyremotedata.implicit_mount
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="light-blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/asgersvenning/pyremotedata" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    PyRemoteData
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../index.html" title="PyRemoteData 0.1.4 documentation" class="md-nav__button md-logo" aria-label="PyRemoteData 0.1.4 documentation" data-md-component="logo">
      <img src="../../_static/cloud_sync.svg" alt="logo">
    </a>
    PyRemoteData 0.1.4 documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/asgersvenning/pyremotedata" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    PyRemoteData
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    <span>Installation</span>
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    <span>Quick Start Guide</span>
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../usage.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    <span>Usage Guide</span>
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../erda.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    <span>Usage with ERDA</span>
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/implicit_mount.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    <span>Implicit Mount Module</span>
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/config.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    <span>Configuration Module</span>
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary">
  
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset" role="main">
                
                
                  


  
    <a href="https://github.com/asgersvenning/pyremotedata/blob/main/docs/_modules/pyremotedata/implicit_mount.rst" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/asgersvenning/pyremotedata/raw/main/docs/_modules/pyremotedata/implicit_mount.rst" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  

<h1>Source code for pyremotedata.implicit_mount</h1><div class="highlight"><pre>
<span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module provides a pythonic interface for downloading files from a remote directory using the SFTP protocol.</span>

<span class="sd">The main functionality of this package is provided through the use of the ImplicitMount, IOHandler and RemotePathIterator classes:</span>

<span class="sd">* The **ImplicitMount** class provides a low-level wrapper for the LFTP shell, which is used to communicate with the remote directory, and should only be used directly by advanced users.</span>

<span class="sd">* The **IOHandler** class provides a high-level wrapper for the ImplicitMount class, which provides human-friendly methods for downloading files from a remote directory without the need to have technical knowledge on how to use LFTP.</span>

<span class="sd">* The **RemotePathIterator** class provides a high-level wrapper for the IOHandler class, and handles asynchronous streaming of files from a remote directory to a local directory using thread-safe buffers.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">queue</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">stat</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">queue</span><span class="w"> </span><span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">random</span><span class="w"> </span><span class="kn">import</span> <span class="n">choices</span><span class="p">,</span> <span class="n">shuffle</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.auto</span><span class="w"> </span><span class="kn">import</span> <span class="n">trange</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyremotedata</span><span class="w"> </span><span class="kn">import</span> <span class="n">CLEAR_LINE</span><span class="p">,</span> <span class="n">ESC_EOL</span><span class="p">,</span> <span class="n">main_logger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyremotedata.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">DEFAULT_LFTP_CONFIG</span><span class="p">,</span> <span class="n">get_implicit_mount_config</span>

<span class="n">BENIGN_ERR</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;(wait|fg): no current job&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="delete_file_or_dir">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.delete_file_or_dir">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_file_or_dir</span><span class="p">(</span>
        <span class="n">path</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">missing_ok</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">force</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">missing_ok</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">raise</span>

    <span class="n">mode</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">st_mode</span>

    <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISLNK</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
        <span class="n">_unlink</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">with</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
            <span class="n">delete_file_or_dir</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">missing_ok</span><span class="o">=</span><span class="n">missing_ok</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWUSR</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">_unlink</span><span class="p">(</span><span class="n">p</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">force</span> <span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWUSR</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="n">IMMUTABLE_DIRECTORIES</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;./&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RemoteType">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.RemoteType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RemoteType</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
    <span class="n">MISSING</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">FILE</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">DIRECTORY</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_missing_</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">NONE</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Only remote modes &quot;MISSING&quot;, &quot;FILE&quot; and &quot;DIRECTORY&quot; are defined, not </span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="c1"># let IntEnum&#39;s default handling raise for bad ints:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_missing_</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="ImplicitMount">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.ImplicitMount">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ImplicitMount</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a low-level wrapper of LFTP, which provides a pythonic interface for executing LFTP commands and reading the output.</span>
<span class="sd">    It provides a robust and efficient backend for communicating with a remote storage server using the SFTP protocol, using a persistent LFTP shell handled in the background by a subprocess.</span>
<span class="sd">    It is designed to be used as a base class for higher-level wrappers, such as the :py:class:`pyremotedata.implicit_mount.IOHandler` class, or as a standalone class for users familiar with LFTP.</span>

<span class="sd">    OBS: The attributes of this method should not be used unless for development or advanced use cases, all responsibility in this case is on the user.</span>

<span class="sd">    Args:</span>
<span class="sd">        user: The username to use for connecting to the remote directory.</span>
<span class="sd">        password: The *SFTP* password to possibly use when connecting to the remote host.</span>
<span class="sd">        remote: The remote server to connect to. If `user` and `password` are supplied, this will default to &#39;io.erda.au.dk&#39; for convenience.</span>
<span class="sd">        port: The port to connect to (default: 2222).</span>
<span class="sd">        verbose: If True, print the commands executed by the class.</span>

<span class="sd">    .. &lt;Sphinx comment</span>
<span class="sd">    Methods:</span>
<span class="sd">        format_options(): Format a dictionary of options into a string of command line arguments.</span>
<span class="sd">        execute_command(): Execute a command on the LFTP shell.</span>
<span class="sd">        mount(): Mount the remote directory.</span>
<span class="sd">        unmount(): Unmount the remote directory.</span>
<span class="sd">        pget(): Download a single file from the remote directory using multiple connections.</span>
<span class="sd">        put(): Upload a single file to the remote directory.</span>
<span class="sd">        ls(): list the contents of a directory (on the remote). OBS: In contrast to the other LFTP commands, this function has a lot of additional functionality, such as recursive listing and caching.</span>
<span class="sd">        lls(): Locally list the contents of a directory.</span>
<span class="sd">        cd(): Change the current directory (on the remote).</span>
<span class="sd">        pwd(): Get the current directory (on the remote).</span>
<span class="sd">        lcd(): Change the current directory (locally).</span>
<span class="sd">        lpwd(): Get the current directory (locally).</span>
<span class="sd">        mirror(): Download a directory from the remote.</span>
<span class="sd">    .. Sphinx comment&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">time_stamp_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*(\S+\s+)</span><span class="si">{8}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># This is used to strip the timestamp from the output of the lftp shell</span>
    <span class="n">END_OF_OUTPUT</span> <span class="o">=</span> <span class="s1">&#39;# LFTP_END_OF_OUTPUT_IDENTIFIER </span><span class="si">{uuid}</span><span class="s1"> #&#39;</span>  <span class="c1"># This is used to signal the end of output when reading from stdout</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">user</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">password</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">remote</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">port</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">2222</span><span class="p">,</span>
            <span class="n">verbose</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="n">main_logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">),</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>
        <span class="c1"># Default argument configuration and type checking</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">password</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">remote</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Since 99.9% of use-cases are for ERDA at the moment, the decrease in friction this </span>
                <span class="c1"># default adds is worth the non-generality (may be changed in the future)</span>
                <span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Defaulting to &#39;io.erda.au.dk&#39; because user and password have been manually passed!&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;default_remote_dir&quot;</span> <span class="p">:</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span>
                <span class="s2">&quot;local_dir&quot;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;remote&quot;</span> <span class="p">:</span> <span class="s2">&quot;io.erda.au.dk&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lftp&quot;</span><span class="p">:</span> <span class="n">DEFAULT_LFTP_CONFIG</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span> <span class="o">=</span> <span class="n">get_implicit_mount_config</span><span class="p">(</span><span class="n">validate</span><span class="o">=</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="nb">str</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">remote</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">remote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span><span class="p">[</span><span class="s1">&#39;remote&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected str, got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">user</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected str, got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">remote</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected bool, got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">verbose</span><span class="p">)))</span>
        
        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;local_dir&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;local_dir&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">local_dir</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">local_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span><span class="p">[</span><span class="s2">&quot;local_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_dir</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">local_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_dir</span> <span class="o">=</span> <span class="n">local_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_local_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_dir</span><span class="p">)</span>
        
        <span class="c1"># Set attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote</span> <span class="o">=</span> <span class="n">remote</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stdout_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span> 

<div class="viewcode-block" id="ImplicitMount.format_options">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.ImplicitMount.format_options">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_options</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format keyword options as LFTP command-line arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs: Keyword arguments to format.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The formatted argument string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># main_logger.debug(f&#39;key: |{key}|, value: |{value}|&#39;)</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;--&quot;</span>
            <span class="n">this_option</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">this_option</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                
            <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_option</span><span class="p">)</span>
            
        <span class="n">options</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">options</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_readerthread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">queue</span> <span class="p">:</span> <span class="n">Queue</span><span class="p">):</span>  <span class="c1"># No longer static</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
                <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_read_stdout</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">uuid_str</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
            <span class="n">timeout</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
            <span class="n">strip_timestamp</span> <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_stamp_pattern</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_stamp_pattern</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">strip_timestamp</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">EoU</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">END_OF_OUTPUT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">uuid_str</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">timeout</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;Timeout while reading stdout&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">EoU</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">strip_timestamp</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_stamp_pattern</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="c1"># if not line.startswith(&quot;wait &quot;):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_error</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>  <span class="c1"># Moved to the else clause</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_error</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_read_stderr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr_queue</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_check_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_stderr</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">BENIGN_ERR</span><span class="p">,</span> <span class="n">err</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_error</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while executing command: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_execute_command</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">command</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
            <span class="n">output</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
            <span class="n">blocking</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
            <span class="n">uuid_str</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a command in the LFTP shell (internal).</span>

<span class="sd">        Notes:</span>
<span class="sd">            Do not use this function directly. Use</span>
<span class="sd">            :meth:`ImplicitMount.execute_command` instead.</span>

<span class="sd">        Args:</span>
<span class="sd">            command: The command to execute.</span>
<span class="sd">            output: If True, return the command output.</span>
<span class="sd">            blocking: If True, wait for command completion. If</span>
<span class="sd">                ``output`` is True, ``blocking`` must also be True.</span>
<span class="sd">            uuid_str: Unique identifier used for delimiting</span>
<span class="sd">                output. Required if ``output`` is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Output lines if ``output`` is True, else</span>
<span class="sd">            None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">output</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">blocking</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Non-blocking output is not supported.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">uuid_str</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">blocking</span> <span class="ow">or</span> <span class="n">output</span><span class="p">):</span>
            <span class="n">uuid_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
            <span class="c1"># raise ValueError(&quot;uuid_str must be specified if output is True.&quot;)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">command</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">command</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span> 
            <span class="c1"># TODO: Is it safe to assume that the order of the output is the same as the order of the commands? Why is it &quot;&lt;command&gt; &lt;end_of_output&gt; wait&quot; and not &quot;&lt;command&gt; wait &lt;end_of_output&gt;&quot;?</span>
            <span class="c1">## Assemble command</span>
            <span class="c1"># Blocking and end of output logic</span>
            <span class="k">if</span> <span class="n">blocking</span> <span class="ow">or</span> <span class="n">output</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;echo </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">END_OF_OUTPUT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">uuid_str</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">blocking</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">+=</span> <span class="s2">&quot;wait</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="c1"># Execute command</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing command: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr_queue</span><span class="o">.</span><span class="n">mutex</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stderr_queue</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout_queue</span><span class="o">.</span><span class="n">mutex</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stdout_queue</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="c1"># Read output</span>
            <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_stdout</span><span class="p">(</span><span class="n">uuid_str</span><span class="o">=</span><span class="n">uuid_str</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">blocking</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_stdout</span><span class="p">(</span><span class="n">uuid_str</span><span class="o">=</span><span class="n">uuid_str</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="ImplicitMount.execute_command">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.ImplicitMount.execute_command">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute_command</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">command</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
            <span class="n">output</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">blocking</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">execute</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">default_args</span> <span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build and optionally execute an LFTP command.</span>

<span class="sd">        Args:</span>
<span class="sd">            command: The LFTP verb (and possibly arguments) to run.</span>
<span class="sd">            output: If True, return the command output.</span>
<span class="sd">            blocking: If True, wait for completion. If ``output`` is</span>
<span class="sd">                True, ``blocking`` must also be True.</span>
<span class="sd">            execute: If False, return the fully formatted command</span>
<span class="sd">                string instead of executing.</span>
<span class="sd">            default_args: Default options merged with</span>
<span class="sd">                ``**kwargs``. Keyword arguments override defaults.</span>
<span class="sd">            **kwargs: Additional options formatted via :meth:`format_options`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            If ``execute`` is False, the formatted command string. </span>
<span class="sd">            If ``output`` is True, a list of output lines (or</span>
<span class="sd">            an empty list). Otherwise, None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Merge default arguments and keyword arguments. Keyword arguments will override default arguments.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default_args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">default_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected dict or None, got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">default_args</span><span class="p">)))</span>
        
        <span class="c1"># Combine default arguments and keyword arguments</span>
        <span class="k">if</span> <span class="n">default_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">default_args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Remove optional &quot;uuid_str&quot; argument from kwargs</span>
        <span class="k">if</span> <span class="s2">&quot;uuid_str&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">uuid_str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;uuid_str&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uuid_str</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Combine default arguments and kwargs</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">default_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span> 
        
        <span class="c1"># Format arguments</span>
        <span class="n">formatted_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_options</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>

        <span class="c1"># Combine command and arguments</span>
        <span class="k">if</span> <span class="s2">&quot; &quot;</span> <span class="ow">in</span> <span class="n">command</span><span class="p">:</span>
            <span class="n">cmd</span><span class="p">,</span> <span class="n">other</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span><span class="p">,</span> <span class="n">other</span> <span class="o">=</span> <span class="n">command</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="n">full_command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">formatted_args</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">other</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">formatted_args</span> <span class="k">else</span> <span class="n">command</span>
        <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">uuid_str</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">uuid_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blocking</span><span class="p">:</span>
            <span class="n">full_command</span> <span class="o">+=</span> <span class="s2">&quot; &amp;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">full_command</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_command</span><span class="p">(</span><span class="n">full_command</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="n">blocking</span><span class="p">,</span> <span class="n">uuid_str</span><span class="o">=</span><span class="n">uuid_str</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">output</span>
            <span class="k">elif</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected list or None, got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">output</span><span class="p">)))</span></div>


<div class="viewcode-block" id="ImplicitMount.mount">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.ImplicitMount.mount">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lftp_settings</span> <span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open a persistent LFTP session and connect to the remote host.</span>

<span class="sd">        Args:</span>
<span class="sd">            lftp_settings: LFTP settings to apply. If None,</span>
<span class="sd">                defaults from configuration are used.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If the subprocess fails to start.</span>
<span class="sd">            RuntimeError: If the connection to the remote directory fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Merge default settings and user settings. User settings will override default settings.</span>
        <span class="n">lftp_settings</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">default_config</span><span class="p">[</span><span class="s1">&#39;lftp&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">lftp_settings</span><span class="p">}</span> <span class="k">if</span> <span class="n">lftp_settings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span><span class="p">[</span><span class="s1">&#39;lftp&#39;</span><span class="p">]</span>
        
        <span class="c1"># Password connect:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;sftp:connect-program&quot;</span> <span class="ow">in</span> <span class="n">lftp_settings</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LFTP setting &#39;sftp:connect-program&#39; cannot be used with password connection!&quot;</span><span class="p">)</span>
            <span class="n">lftp_settings</span><span class="p">[</span><span class="s2">&quot;sftp:connect-program&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ssh -a -x -o PreferredAuthentications=password -o PubkeyAuthentication=no&quot;</span>

        <span class="c1"># Format settings</span>
        <span class="n">lftp_settings_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">lftp_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">lftp_settings_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; set </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mounting </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">remote</span><span class="si">}</span><span class="s2"> as </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># &quot;Mount&quot; the remote directory using an lftp shell with the sftp protocol and the specified user and remote, and the specified lftp settings</span>
        <span class="n">lftp_mount_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;open -u </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="si">}</span><span class="s1"> -p </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s1"> sftp://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">remote</span><span class="si">}</span><span class="s1">;</span><span class="si">{</span><span class="n">lftp_settings_str</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing command: lftp&quot;</span><span class="p">)</span>
        <span class="c1"># Start the lftp shell</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
                <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;lftp&quot;</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">bufsize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># TODO: The exception should probably be a bit more specific</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to start subprocess.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="c1"># Start the stdout and stderr reader threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_readerthread</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout_queue</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_readerthread</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr_queue</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Set the threads as daemon threads so that they will be terminated when the main thread terminates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># Start the threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># Execute the mount command on the lftp shell (connect to the remote directory)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">lftp_mount_cmd</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_config</span><span class="p">[</span><span class="s1">&#39;default_remote_dir&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;lcd </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for connection...&quot;</span><span class="p">)</span>
        <span class="c1"># Check if we are connected to the remote directory by executing the pwd command on the lftp shell</span>
        <span class="n">connected_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connected to </span><span class="si">{</span><span class="n">connected_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">connected_path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unmount</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to connect. Check internet connection or if </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">remote</span><span class="si">}</span><span class="s2"> is online.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ImplicitMount.unmount">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.ImplicitMount.unmount">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">unmount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Terminate the LFTP session and release resources.</span>

<span class="sd">        Args:</span>
<span class="sd">            timeout: Maximum time to wait before forcefully</span>
<span class="sd">                terminating the process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Close Popen streams explicitly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s2">&quot;exit kill top&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">waited</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">waited</span> <span class="o">+=</span> <span class="mf">0.1</span>
            <span class="k">if</span> <span class="n">waited</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lftp_shell</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImplicitMount.exists">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.ImplicitMount.exists">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">exists</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mode</span> <span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">,</span>
        <span class="n">execute</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a path (file/directory/link) exists.</span>

<span class="sd">        Args:</span>
<span class="sd">            path: Path to check.</span>
<span class="sd">            mode: Which types of file to match. Not-case sensitive, </span>
<span class="sd">                currently &quot;any&quot; (default), &quot;file&quot; and &quot;directory&quot; are supported.</span>
<span class="sd">            **kwargs: Additional arguments passed to execute_command.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Boolean if `execute=True` else the command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unexpected exist type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="c1"># Some paths are &quot;base-cases&quot; that should exist in all cases:</span>
        <span class="c1"># - Current directory</span>
        <span class="c1"># - Parent directory of current directory</span>
        <span class="c1"># - Root directory</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;/.&quot;</span><span class="p">,</span> <span class="s2">&quot;./&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;NO CMD&quot;</span>
            <span class="k">return</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;any&quot;</span><span class="p">,</span> <span class="s2">&quot;directory&quot;</span><span class="p">]</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="c1"># Recursively check if the parent directories exist to avoid error in glob expansion</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;directory&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="c1"># Get glob mode-argument</span>
        <span class="k">match</span> <span class="n">mode</span><span class="p">:</span>
            <span class="k">case</span> <span class="s2">&quot;any&quot;</span><span class="p">:</span>
                <span class="n">type_arg</span> <span class="o">=</span> <span class="s2">&quot;-a&quot;</span>
            <span class="k">case</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
                <span class="n">type_arg</span> <span class="o">=</span> <span class="s2">&quot;-f&quot;</span>
            <span class="k">case</span> <span class="s2">&quot;directory&quot;</span><span class="p">:</span>
                <span class="n">type_arg</span> <span class="o">=</span> <span class="s2">&quot;-d&quot;</span>
        <span class="c1"># Check if file is hidden, needs special handling: https://en.wikipedia.org/wiki/Glob_(programming)#Origin</span>
        <span class="n">hidden</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">exist_glob</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="s2">&quot;.&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">hidden</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1">*</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">glob_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;glob </span><span class="si">{</span><span class="n">type_arg</span><span class="si">}</span><span class="s1"> --exist &quot;</span><span class="si">{</span><span class="n">exist_glob</span><span class="si">}</span><span class="s1">&quot; &amp;&amp; echo &quot;YES&quot; || echo &quot;NO&quot;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">glob_result</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">glob_result</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob_result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">glob_result</span> <span class="o">=</span> <span class="n">glob_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unexpected return value: </span><span class="si">{</span><span class="n">glob_result</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">glob_result</span> <span class="o">==</span> <span class="s2">&quot;YES&quot;</span></div>

    
<div class="viewcode-block" id="ImplicitMount.pathtype">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.ImplicitMount.pathtype">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pathtype</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">remote_path</span> <span class="p">:</span> <span class="nb">str</span>
        <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">RemoteType</span><span class="o">.</span><span class="n">MISSING</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;directory&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">RemoteType</span><span class="o">.</span><span class="n">DIRECTORY</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;file&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">RemoteType</span><span class="o">.</span><span class="n">FILE</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown remote path type &quot;</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s1">&quot; exists, but is not a file or directory?&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ImplicitMount.get">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.ImplicitMount.get">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">remote_path</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
            <span class="n">local_path</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">execute</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download file(s) using LFTP ``get``.</span>

<span class="sd">        Args:</span>
<span class="sd">            remote_path: Remote file path to download.</span>
<span class="sd">            local_path: Local download destination path. If</span>
<span class="sd">                None, downloads to the current local directory.</span>
<span class="sd">            execute: If False, return the command string.</span>
<span class="sd">            **kwargs: Additional options forwarded to ``put``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Command string(s) when ``execute`` is False; otherwise, local destination path(s) based on the type of `remote_path`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rettype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid download path type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">remote_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">remote_path</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">local_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">local_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span> <span class="k">for</span> <span class="n">rp</span> <span class="ow">in</span> <span class="n">remote_path</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">local_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">local_path</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of local paths (destination) must match number of remote paths (source), but: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span><span class="si">=}</span><span class="s1"> &amp; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rettype</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">retorder</span> <span class="o">=</span> <span class="p">{</span><span class="n">rp</span> <span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">rp</span> <span class="ow">in</span> <span class="n">remote_path</span><span class="p">}</span>
            <span class="n">cmds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">local_destination_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="s2">&quot;.&quot;</span> <span class="k">for</span> <span class="n">lp</span> <span class="ow">in</span> <span class="n">local_path</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">local_destination_dir</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">local_destination_dirs</span><span class="p">):</span>
                <span class="n">dir_remote_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">rp</span> <span class="k">for</span> <span class="n">rp</span><span class="p">,</span> <span class="n">ldd</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">local_destination_dirs</span><span class="p">)</span> <span class="k">if</span> <span class="n">ldd</span> <span class="o">==</span> <span class="n">local_destination_dir</span><span class="p">]</span>
                <span class="n">dir_retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mget</span><span class="p">(</span><span class="n">dir_remote_paths</span><span class="p">,</span> <span class="n">local_destination_dir</span><span class="o">=</span><span class="n">local_destination_dir</span><span class="p">,</span> <span class="n">execute</span><span class="o">=</span><span class="n">execute</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
                    <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dir_retval</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">rv</span><span class="p">,</span> <span class="n">rp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dir_retval</span><span class="p">,</span> <span class="n">dir_remote_paths</span><span class="p">):</span>
                    <span class="n">retorder</span><span class="p">[</span><span class="n">rp</span><span class="p">]</span> <span class="o">=</span> <span class="n">rv</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cmds</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="p">[</span><span class="n">retorder</span><span class="p">[</span><span class="n">rp</span><span class="p">]</span> <span class="k">for</span> <span class="n">rp</span> <span class="ow">in</span> <span class="n">remote_path</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">rettype</span><span class="p">(</span><span class="n">retval</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">remote_path</span><span class="p">,</span> <span class="n">local_path</span> <span class="o">=</span> <span class="n">remote_path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">local_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">local_path</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">local_dir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">IMMUTABLE_DIRECTORIES</span> <span class="ow">and</span> <span class="p">(</span><span class="n">local_dir</span> <span class="o">!=</span> <span class="n">local_path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">local_dir</span><span class="p">)</span>
        <span class="n">exec_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span>
            <span class="c1"># f&quot;get &quot; + &quot; &quot;.join(f&#39;{rp} -o {lp}&#39; for rp, lp in zip(remote_path, local_path)),</span>
            <span class="sa">f</span><span class="s1">&#39;get &quot;</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s1">&quot; -o &quot;</span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
            <span class="n">execute</span><span class="o">=</span><span class="n">execute</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">exec_output</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">local_path</span> <span class="k">if</span> <span class="n">local_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">()</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">rettype</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rettype</span><span class="p">([</span><span class="n">retval</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">retval</span></div>

    
<div class="viewcode-block" id="ImplicitMount.mget">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.ImplicitMount.mget">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mget</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">remote_paths</span> <span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
        <span class="n">local_destination_dir</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">execute</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default_args</span> <span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">local_destination_dir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">IMMUTABLE_DIRECTORIES</span> <span class="ow">and</span> 
            <span class="p">(</span><span class="n">local_destination_dir</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">local_destination_dir</span><span class="p">))</span> <span class="ow">and</span> 
            <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_destination_dir</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">local_destination_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">local_destination_dir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`local_destination_dir`: </span><span class="si">{</span><span class="n">local_destination_dir</span><span class="si">}</span><span class="s1"> is not a directory.&#39;</span><span class="p">)</span>
        <span class="n">default_args</span> <span class="o">=</span> <span class="n">default_args</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;P&quot;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">default_args</span><span class="p">}</span>
        <span class="n">exec_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span>
            <span class="s2">&quot;mget &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">for</span> <span class="n">rp</span> <span class="ow">in</span> <span class="n">remote_paths</span><span class="p">]),</span>
            <span class="n">execute</span><span class="o">=</span><span class="n">execute</span><span class="p">,</span>
            <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">,</span>
            <span class="n">O</span><span class="o">=</span><span class="n">local_destination_dir</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">exec_output</span>
        <span class="n">ldst</span> <span class="o">=</span> <span class="n">local_destination_dir</span> <span class="k">if</span> <span class="n">local_destination_dir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">()</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">local_destination_dir</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ldst</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">rp</span> <span class="ow">in</span> <span class="n">remote_paths</span><span class="p">]</span></div>

        

<div class="viewcode-block" id="ImplicitMount.pget">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.ImplicitMount.pget">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pget</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">remote_path</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
            <span class="n">local_path</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> 
            <span class="n">execute</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">default_args</span> <span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download a single file using LFTP ``pget``.</span>

<span class="sd">        Args:</span>
<span class="sd">            remote_path: Remote file path to download.</span>
<span class="sd">            local_path: Local path destination, defaults to remote basename in current local directory.</span>
<span class="sd">            execute: If False, return the command string instead of</span>
<span class="sd">                executing.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Absolute local path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Construct and return the absolute local path</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">remote_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">local_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
            <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">subdir</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">local_path</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))):</span>
                <span class="k">pass</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">subdir</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pget</span><span class="p">(</span><span class="n">remote_path</span><span class="o">=</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">local_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">),</span> <span class="n">execute</span><span class="o">=</span><span class="n">execute</span><span class="p">,</span> <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">local_dir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">IMMUTABLE_DIRECTORIES</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">local_dir</span><span class="p">)</span>

        <span class="n">default_args</span> <span class="o">=</span> <span class="n">default_args</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;n&quot;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">default_args</span><span class="p">}</span>

        <span class="n">full_command</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;pget &quot;</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s1">&quot; -o &quot;</span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="n">exec_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span>
            <span class="n">full_command</span><span class="p">,</span>
            <span class="n">execute</span><span class="o">=</span><span class="n">execute</span><span class="p">,</span>
            <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">exec_output</span>
        
        <span class="k">return</span> <span class="n">local_path</span> <span class="k">if</span> <span class="n">local_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">()</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s1">&#39;</span></div>

    
<div class="viewcode-block" id="ImplicitMount.put">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.ImplicitMount.put">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">put</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">local_path</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
            <span class="n">remote_path</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">execute</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Upload file(s) using LFTP ``put``.</span>

<span class="sd">        Args:</span>
<span class="sd">            local_path: Local file(s) to upload.</span>
<span class="sd">            remote_path: Remote file path(s) to upload to. If</span>
<span class="sd">                None, uploads to the current remote directory.</span>
<span class="sd">            execute: If False, return the command string.</span>
<span class="sd">            **kwargs: Additional options forwarded to ``put``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Command string(s) when ``execute`` is False; otherwise, remote destination path(s) based on the type of `remote_path`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rettype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid upload path type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">local_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">local_path</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">remote_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">remote_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span> <span class="k">for</span> <span class="n">lp</span> <span class="ow">in</span> <span class="n">local_path</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">remote_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">remote_path</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of local paths (destination) must match number of remote paths (source), but: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span><span class="si">=}</span><span class="s1"> &amp; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rettype</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">retorder</span> <span class="o">=</span> <span class="p">{</span><span class="n">lp</span> <span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">lp</span> <span class="ow">in</span> <span class="n">local_path</span><span class="p">}</span>
            <span class="n">cmds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">remote_destination_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="s2">&quot;.&quot;</span> <span class="k">for</span> <span class="n">rp</span> <span class="ow">in</span> <span class="n">remote_path</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">remote_destination_dir</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">remote_destination_dirs</span><span class="p">):</span>
                <span class="n">dir_local_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">lp</span> <span class="k">for</span> <span class="n">lp</span><span class="p">,</span> <span class="n">rdd</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">remote_destination_dirs</span><span class="p">)</span> <span class="k">if</span> <span class="n">rdd</span> <span class="o">==</span> <span class="n">remote_destination_dir</span><span class="p">]</span>
                <span class="n">dir_retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mput</span><span class="p">(</span><span class="n">dir_local_paths</span><span class="p">,</span> <span class="n">remote_destination_dir</span><span class="o">=</span><span class="n">remote_destination_dir</span><span class="p">,</span> <span class="n">execute</span><span class="o">=</span><span class="n">execute</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
                    <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dir_retval</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">rv</span><span class="p">,</span> <span class="n">lp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dir_retval</span><span class="p">,</span> <span class="n">dir_local_paths</span><span class="p">):</span>
                    <span class="n">retorder</span><span class="p">[</span><span class="n">lp</span><span class="p">]</span> <span class="o">=</span> <span class="n">rv</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cmds</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="p">[</span><span class="n">retorder</span><span class="p">[</span><span class="n">lp</span><span class="p">]</span> <span class="k">for</span> <span class="n">lp</span> <span class="ow">in</span> <span class="n">local_path</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">rettype</span><span class="p">(</span><span class="n">retval</span><span class="p">)</span>
        <span class="n">remote_path</span><span class="p">,</span> <span class="n">local_path</span> <span class="o">=</span> <span class="n">remote_path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">local_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">remote_dir</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">remote_dir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">IMMUTABLE_DIRECTORIES</span> <span class="ow">and</span> <span class="n">remote_dir</span> <span class="o">!=</span> <span class="n">remote_path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mkdir -p &quot;</span><span class="si">{</span><span class="n">remote_dir</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">exec_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;put &quot;</span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s1">&quot; -o &quot;</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
            <span class="n">execute</span><span class="o">=</span><span class="n">execute</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">exec_output</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">remote_path</span> <span class="k">if</span> <span class="n">remote_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">()</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">rettype</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rettype</span><span class="p">([</span><span class="n">retval</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">retval</span></div>

    
<div class="viewcode-block" id="ImplicitMount.mput">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.ImplicitMount.mput">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mput</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">local_paths</span> <span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
        <span class="n">remote_destination_dir</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">execute</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default_args</span> <span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>
        <span class="k">if</span> <span class="n">remote_destination_dir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">IMMUTABLE_DIRECTORIES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mkdir -p &quot;</span><span class="si">{</span><span class="n">remote_destination_dir</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
        <span class="n">default_args</span> <span class="o">=</span> <span class="n">default_args</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;P&quot;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">default_args</span><span class="p">}</span>
        <span class="n">exec_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span>
            <span class="s2">&quot;mput &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_paths</span><span class="p">),</span>
            <span class="n">execute</span><span class="o">=</span><span class="n">execute</span><span class="p">,</span>
            <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">,</span>
            <span class="n">O</span><span class="o">=</span><span class="n">remote_destination_dir</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">exec_output</span>
        <span class="n">ldst</span> <span class="o">=</span> <span class="n">remote_destination_dir</span> <span class="k">if</span> <span class="n">remote_destination_dir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">()</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">remote_destination_dir</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ldst</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">lp</span> <span class="ow">in</span> <span class="n">local_paths</span><span class="p">]</span></div>

    
<div class="viewcode-block" id="ImplicitMount.rm">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.ImplicitMount.rm">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
        <span class="n">force</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">execute</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">blocking</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove a file or directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            path: File or directory to delete.</span>
<span class="sd">            force: Force deletion of path (rm -rf), directories can only be deleted with this argument (empty or not).</span>
<span class="sd">            **kwargs: Additional arguments passed to execute_command.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            The command `execute=False` else None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;r&quot;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">}</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s1">&#39;rm &#39;</span> <span class="o">+</span> <span class="s1">&#39; &amp; rm &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">blocking</span><span class="o">=</span><span class="n">blocking</span><span class="p">,</span> <span class="n">execute</span><span class="o">=</span><span class="n">execute</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">retval</span></div>

        
<div class="viewcode-block" id="ImplicitMount.du">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.ImplicitMount.du">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">du</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="nb">all</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="nb">bytes</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">execute</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">blocking</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default_args</span> <span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the size of a directory/path.</span>

<span class="sd">        Args:</span>
<span class="sd">            path: Path to examine.</span>
<span class="sd">            all: Return size of all files and subdirectories of path, including path itself, separately.</span>
<span class="sd">            bytes: Return size in bytes, otherwise in KB.</span>
<span class="sd">            **kwargs: Passed to execute_command.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            A dict with path(s) as keys and size as values, if `blocking=False` None and if `execute=False` the command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">default_args</span> <span class="o">=</span> <span class="n">default_args</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;all&quot;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;bytes&quot;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">default_args</span><span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">:</span>
            <span class="n">default_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">bytes</span><span class="p">:</span>
            <span class="n">default_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;bytes&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;du &quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&quot; | cat&#39;</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="n">blocking</span><span class="p">,</span> <span class="n">execute</span><span class="o">=</span><span class="n">execute</span><span class="p">,</span> <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blocking</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">retval</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unexpected return value: </span><span class="si">{</span><span class="n">retval</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">size_path</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">size_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">retval</span> <span class="k">if</span> <span class="p">(</span><span class="n">size_path</span> <span class="o">:=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)))</span></div>


<div class="viewcode-block" id="ImplicitMount.ls">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.ImplicitMount.ls">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ls</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">path</span> <span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
            <span class="n">recursive</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">use_cache</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">pbar</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">_top</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List files in a remote directory (optionally recursively).</span>

<span class="sd">        Uses LFTP ``cls`` (and manual traversal for recursion) to return file</span>
<span class="sd">        paths relative to ``path``.</span>

<span class="sd">        Args:</span>
<span class="sd">            path: Remote directory to search.</span>
<span class="sd">            recursive: If True, search recursively.</span>
<span class="sd">            use_cache: If True, use ``cls`` (cached). If False, use ``recls`` to force refresh.</span>
<span class="sd">            pbar: Progress heartbeat for recursive listings (0 to disable).</span>

<span class="sd">        Returns:</span>
<span class="sd">           Relative file paths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;ls does not support relative backtracing paths yet.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;./&quot;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">path</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="c1"># This function is used to sanitize the output of the lftp shell</span>
        <span class="c1"># It is quite inefficient, but it is only used for the ls command, which is not performance critical?</span>
        <span class="c1"># Folder index files should be used instead of ls in most cases, </span>
        <span class="c1"># but this function is still useful for debugging and for creating the folder index files</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">sanitize_path</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Empty case (base case 1)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># Single path case (base case 2)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="c1"># Skip &quot;.&quot; and &quot;..&quot; paths and folder index files (these are created by the folder index command, and should be treated as hidden files)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s2">&quot;folder_index.txt&quot;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                    <span class="c1"># Remove leading &quot;./&quot; from paths</span>
                    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;./&quot;</span><span class="p">):</span>
                        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                    <span class="c1"># Append path to list (this a mutative operation)</span>
                    <span class="n">l</span> <span class="o">+=</span> <span class="p">[</span><span class="n">path</span><span class="p">]</span>
            <span class="c1"># Multiple paths case (recursive case)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                    <span class="n">sanitize_path</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected list, str or None, got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">l</span>
        
        <span class="c1"># Recursive ls is implemented by using the &quot;cls&quot; command, which returns a list of permissions and paths</span>
        <span class="c1"># and then recursively calling ls on each of the paths that are directories, </span>
        <span class="c1"># which is determined by checking if the permission starts with &quot;d&quot;</span>
        <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
            <span class="n">recls</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">use_cache</span> <span class="k">else</span> <span class="s2">&quot;re&quot;</span>
            <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">CLEAR_LINE</span><span class="si">}</span><span class="s2">Retrieving file list</span><span class="si">{</span><span class="s1">&#39;.&#39;</span><span class="o">*</span><span class="n">pbar</span><span class="si">}{</span><span class="n">ESC_EOL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">this_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">recls</span><span class="si">}</span><span class="s1">cls &quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&quot; -1 --perm&#39;</span><span class="p">)</span>
            <span class="c1"># If the directory contains one or no files</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">this_level</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">this_level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">this_level</span> <span class="o">=</span> <span class="n">sanitize_path</span><span class="p">([],</span> <span class="n">this_level</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">perm_path</span> <span class="ow">in</span> <span class="n">this_level</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot; &quot;</span> <span class="ow">in</span> <span class="n">perm_path</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">perm</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">perm_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">perm</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">):</span>
                    <span class="n">pbar</span> <span class="o">=</span> <span class="p">(</span><span class="n">pbar</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">pbar</span> <span class="k">else</span> <span class="n">pbar</span>
                    <span class="n">output</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="n">pbar</span><span class="p">,</span> <span class="n">_top</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sanitize_path</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="c1"># Non-recursive case</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">sanitize_path</span><span class="p">([],</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cls -1 &quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">))</span>
        
        <span class="c1"># Clear the progress bar if end of top-level</span>
        <span class="k">if</span> <span class="n">pbar</span> <span class="ow">and</span> <span class="n">_top</span><span class="p">:</span>
            <span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">CLEAR_LINE</span><span class="si">}{</span><span class="n">ESC_EOL</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check if the output is a list</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected list, got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">output</span><span class="p">)))</span>
        
        <span class="k">return</span> <span class="n">output</span></div>

    
<div class="viewcode-block" id="ImplicitMount.lls">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.ImplicitMount.lls">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List files in a local directory via the LFTP shell.</span>

<span class="sd">        Args:</span>
<span class="sd">            local_path: </span>

<span class="sd">        Notes:</span>
<span class="sd">            Prefer native Python/OS listing. This is mainly useful for</span>
<span class="sd">            consistency and debugging through the same LFTP session.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;posix&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;IOHandler.lls() is not supported in non-Unix-like OSs (Windows)&quot;</span><span class="p">)</span>
        <span class="n">recursive</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;recursive&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">recursive</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">local_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">local_path</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;!find &quot;</span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s1">&quot; -type f -exec realpath --relative-to=&quot;</span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s1">&quot; </span><span class="se">{{}}</span><span class="s1"> </span><span class="se">\\</span><span class="s1">; | cat&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;!ls &quot;</span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s1">&quot; | cat&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="c1"># Check if the output is a list</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected list, got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">output</span><span class="p">)))</span>
        
        <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="ImplicitMount.cd">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.ImplicitMount.cd">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_path</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cd &quot;</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s1">&quot; &amp;&amp; cd .&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="ImplicitMount.pwd">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.ImplicitMount.pwd">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pwd</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the current remote directory (LFTP ``pwd``).&quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s2">&quot;pwd&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected list of length 1, got </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="n">output</span><span class="p">))</span></div>


<div class="viewcode-block" id="ImplicitMount.lcd">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.ImplicitMount.lcd">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lcd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_path</span> <span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Change the current local directory (LFTP ``lcd``).</span>

<span class="sd">        Args:</span>
<span class="sd">           local_path: Local directory to change to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_dir</span><span class="p">,</span> <span class="n">local_path</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">local_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">local_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;lcd </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="ImplicitMount.lpwd">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.ImplicitMount.lpwd">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lpwd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the current local directory.</span>

<span class="sd">        Returns:</span>
<span class="sd">           The current local directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_dir</span></div>


<div class="viewcode-block" id="ImplicitMount.mirror">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.ImplicitMount.mirror">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mirror</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">remote</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">local</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">reverse</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">output</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">blocking</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">execute</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">default_args</span> <span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mirror a remote directory to a local destination (LFTP ``mirror``).</span>

<span class="sd">        Args:</span>
<span class="sd">            remote: Remote directory to download (if not reverse).</span>
<span class="sd">            local: Local destination directory (if not reverse).</span>
<span class="sd">            reverse: Upload from `local` to `destination`.</span>
<span class="sd">            **kwargs: Additional options forwarded to ``mirror``.</span>

<span class="sd">        Returns:</span>
<span class="sd">           List of newly downloaded files or following `ImplicitMount.execute_command`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;R&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Passing `R` to IOHandler.mirror is not supported, please use `reverse` instead.&#39;</span><span class="p">)</span>
        <span class="c1"># Infer default destination</span>
        <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">remote</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">remote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">local</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;When reverse mirroring (uploading) local source must be specified.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">local</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">reverse</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;When mirroring (downloading) remote source must be specified.&#39;</span><span class="p">)</span>
        <span class="c1"># Prune trailing forward slash (path separators)</span>
        <span class="k">while</span> <span class="n">remote</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="n">remote</span> <span class="o">=</span> <span class="n">remote</span><span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">local</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="n">local</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="c1"># Capture the state of the directory before the operation</span>
        <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
                <span class="n">pre_existing_files</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">remote</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">remote</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pre_existing_files</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">local</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lls</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
            <span class="n">pre_existing_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pre_existing_files</span><span class="p">)</span>

        <span class="c1"># Execute the mirror command</span>
        <span class="n">default_args</span> <span class="o">=</span> <span class="n">default_args</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;use-cache&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">default_args</span><span class="p">}</span>
        <span class="n">exec_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;mirror &quot;</span><span class="si">{</span><span class="n">local</span><span class="si">}</span><span class="s1">&quot; &quot;</span><span class="si">{</span><span class="n">remote</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">if</span> <span class="n">reverse</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;mirror &quot;</span><span class="si">{</span><span class="n">remote</span><span class="si">}</span><span class="s1">&quot; &quot;</span><span class="si">{</span><span class="n">local</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span> 
            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
            <span class="n">blocking</span><span class="o">=</span><span class="n">blocking</span><span class="p">,</span> 
            <span class="n">execute</span><span class="o">=</span><span class="n">execute</span><span class="p">,</span>
            <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">,</span> 
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">exec_output</span>
        
        <span class="c1"># Capture the state of the directory after the operation</span>
        <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
                <span class="n">post_download_files</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">remote</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">remote</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">post_download_files</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">local</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lls</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
            <span class="n">post_download_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">post_download_files</span><span class="p">)</span>
            
            <span class="c1"># Return new files in destination after operation (assumes that no other processes modify the destination)</span>
            <span class="n">new_files</span> <span class="o">=</span> <span class="n">post_download_files</span> <span class="o">-</span> <span class="n">pre_existing_files</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_files</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="IOHandler">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.IOHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">IOHandler</span><span class="p">(</span><span class="n">ImplicitMount</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a high-level wrapper for the :py:class:`pyremotedata.implicit_mount.ImplicitMount` class, which provides human-friendly methods for downloading files from a remote directory without the need to have technical knowledge on how to use LFTP.</span>

<span class="sd">    To avoid SSH setup use `lftp_settings = {&#39;sftp:connect-program&#39; : &#39;ssh -a -x -i &lt;keyfile&gt;&#39;}, user = &lt;USER&gt;, remote = &lt;REMOTE&gt;`.</span>

<span class="sd">    OBS: The attributes of this method should not be used unless for development or advanced use cases, all responsibility in this case is on the user.</span>

<span class="sd">    Args:</span>
<span class="sd">        local_dir: The local directory to use for downloading files. If None, a temporary directory will be used (suggested, unless truly necessary).</span>
<span class="sd">        user_confirmation: If True, the user will be asked for confirmation before deleting files. (strongly suggested for debugging and testing)</span>
<span class="sd">        clean: If True, the local directory will be cleaned after the context manager is exited. (suggested, if not it may lead to rapid exhaustion of disk space)</span>
<span class="sd">        lftp_settings: Add any additional settings or setting overrides (see https://lftp.yar.ru/lftp-man.html). </span>
<span class="sd">            The most common usecase is properly to use `lftp_settings = {&#39;sftp:connect-program&#39; : &#39;ssh -a -x -i &lt;keyfile&gt;&#39;}`.</span>
<span class="sd">            The defaults can also be overwritten by changing the `PyRemoteData` config file.</span>
<span class="sd">        user: The username to use for connecting to the remote directory.</span>
<span class="sd">        password: The *SFTP* password to possibly use when connecting to the remote host.</span>
<span class="sd">        remote: The remote server to connect to.</span>
<span class="sd">        **kwargs: Keyword arguments to pass to the :py:class:`pyremotedata.implicit_mount.ImplicitMount` constructor.</span>

<span class="sd">    .. &lt;Sphinx comment</span>
<span class="sd">    Methods:</span>
<span class="sd">        download(): Download the given remote path(s) to the given local destination(s).</span>
<span class="sd">        clone(): Clone the current remote directory to the given local destination.</span>
<span class="sd">        get_file_index(): Get a list of files in the current directory.</span>
<span class="sd">        cache_file_index(): Cache the file index for the current directory.</span>
<span class="sd">        clean(): Clean the local directory.</span>
<span class="sd">        clean_last(): Clean the last downloaded file or directory.</span>
<span class="sd">    .. Sphinx comment&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">local_dir</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">user_confirmation</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
            <span class="n">clean</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
            <span class="n">user</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">password</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">remote</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">lftp_settings</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
            <span class="n">remote</span><span class="o">=</span><span class="n">remote</span><span class="p">,</span>
            <span class="n">local_dir</span><span class="o">=</span><span class="n">local_dir</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_confirmation</span> <span class="o">=</span> <span class="n">user_confirmation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_clean</span> <span class="o">=</span> <span class="n">clean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lftp_settings</span> <span class="o">=</span> <span class="n">lftp_settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IOHandler&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Opens the remote connection in a background shell.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lftp_settings</span> <span class="ow">or</span> <span class="p">{})</span>

        <span class="c1"># Print local directory:</span>
        <span class="c1"># if the local directory is not specified in the config, </span>
        <span class="c1"># it is a temporary directory, so it is nice to know where it is located</span>
        <span class="n">main_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Local directory: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Return self</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Positional and keyword arguments simply catch any arguments passed to the function to be ignored</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_clean</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unmount</span><span class="p">()</span>

    <span class="c1"># Methods for using the IOHandler without context management</span>
<div class="viewcode-block" id="IOHandler.start">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.IOHandler.start">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the connection to the remote directory.</span>

<span class="sd">        Very useful for interactive use, but shouldn&#39;t be used in scripts, using a context manager is safer and does the same.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>

        <span class="n">main_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;IOHandler.start() is unsafe. Use IOHandler.__enter__() instead if possible.&quot;</span><span class="p">)</span>
        <span class="n">main_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;OBS: Remember to call IOHandler.stop() when you are done.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="IOHandler.stop">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.IOHandler.stop">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close the connection to the remote directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">()</span></div>


<div class="viewcode-block" id="IOHandler.download">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.IOHandler.download">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">download</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">remote_path</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
            <span class="n">local_destination</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">n</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
            <span class="n">blocking</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Downloads one or more files or a directory from the remote directory to the given local destination.</span>

<span class="sd">        Args:</span>
<span class="sd">            remote_path: The remote path(s) to download.</span>
<span class="sd">            local_destination: The local destination directory(s) to download the file(s) to. If None, the file(s) will be downloaded to the current local directory.</span>
<span class="sd">            n: Parallel connections to use if relevant (default=14).</span>
<span class="sd">            blocking: If True, the function will block until the download is complete.</span>
<span class="sd">            **kwargs: Extra keyword arguments are passed to the IOHandler.multi_download, IOHandler.pget or IOHandler.mirror functions depending on the type of the remote path(s).</span>

<span class="sd">        Returns:</span>
<span class="sd">           The local path(s) of the downloaded file(s) or directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">match</span> <span class="bp">self</span><span class="o">.</span><span class="n">pathtype</span><span class="p">(</span><span class="n">remote_path</span><span class="p">):</span>
                <span class="k">case</span> <span class="n">RemoteType</span><span class="o">.</span><span class="n">MISSING</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Missing download target: &quot;</span> <span class="o">+</span> <span class="n">remote_path</span><span class="p">)</span>
                <span class="k">case</span> <span class="n">RemoteType</span><span class="o">.</span><span class="n">DIRECTORY</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">local_destination</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Downloading directories should have a single destination!&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mirror</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">local_destination</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="n">blocking</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">case</span> <span class="n">RemoteType</span><span class="o">.</span><span class="n">FILE</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">local_destination</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Downloading single files should have a single destination!&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">local_destination</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">local_destination</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">local_destination</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">remote_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pget</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">local_destination</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="n">blocking</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Remote download path exists, but is not a file or directory?&#39;</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_path</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">local_destination</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading multiple files should have a single destination dir or list of these, not </span><span class="si">{</span><span class="n">local_destination</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">local_destination</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">local_destination</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">rp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">rp</span> <span class="ow">in</span> <span class="n">remote_path</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">local_destination</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">remote_path</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Destination and remote paths (source) have different lengths: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">local_destination</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">{</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)}</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">local_destination</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lp</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">rp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">lp</span><span class="p">,</span> <span class="n">rp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">)]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">local_destination</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="n">blocking</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="IOHandler.upload">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.IOHandler.upload">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">upload</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">local_path</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
            <span class="n">remote_destination</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">n</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
            <span class="n">blocking</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uploads one or more files or a directory to the remote destination.</span>

<span class="sd">        Args:</span>
<span class="sd">            local_path: The local file(s) or directory to upload.</span>
<span class="sd">            remote_destination: Remote destination directory(s) of uploaded files. If None will upload to current remote directory.</span>
<span class="sd">            n: Parallel connections to use if relevant (default=14).</span>
<span class="sd">            blocking: If True, the function will block until the download is complete.</span>
<span class="sd">            **kwargs: Extra keyword arguments are passed to the IOHandler.multi_download, IOHandler.pget or IOHandler.mirror functions depending on the type of the remote path(s).</span>

<span class="sd">        Returns:</span>
<span class="sd">           The local path(s) of the downloaded file(s) or directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Missing upload target: &quot;</span> <span class="o">+</span> <span class="n">local_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">remote_destination</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">remote_destination</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Uploading directories should have a single destination!&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mirror</span><span class="p">(</span><span class="n">remote_destination</span><span class="p">,</span> <span class="n">local_path</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="n">blocking</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">remote_destination</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote_destination</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Uploading single files should have a single destination!&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">remote_destination</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">remote_destination</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">remote_destination</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">local_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">remote_destination</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="n">blocking</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Local upload path exists, but is not a file or directory?&#39;</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">local_path</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remote_destination</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote_destination</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote_destination</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uploading multiple files should have a single destination dir, or list of these, not </span><span class="si">{</span><span class="n">remote_destination</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">remote_destination</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">remote_destination</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">lp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">lp</span> <span class="ow">in</span> <span class="n">local_path</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remote_destination</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Destination and local paths (source) have different lengths: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">remote_destination</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">{</span><span class="nb">len</span><span class="p">(</span><span class="n">local_path</span><span class="p">)}</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">remote_destination</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">lp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">rp</span><span class="p">,</span> <span class="n">lp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">remote_destination</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">remote_destination</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="n">blocking</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="IOHandler.sync">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.IOHandler.sync">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sync</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">local_destination</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">direction</span> <span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;down&quot;</span><span class="p">,</span>
            <span class="n">allow_root</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">progress</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">batch_size</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
            <span class="n">replace_local</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">refresh_cache</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Synchronized the current remote directory to the given local destination.</span>

<span class="sd">        Args:</span>
<span class="sd">            local_destination: The local destination to synchronize the current remote directory to, </span>
<span class="sd">                defaults to &quot;&lt;CURRENT_LOCAL_DIRECTORY_PATH&gt;/&lt;CURRENT_REMOTE_DIRECTORY_NAME&gt;&quot;.</span>
<span class="sd">            direction: Synchronization directory; one of non-case-sensitive [&quot;down&quot;, &quot;up&quot;, &quot;both&quot;] (default=&quot;down&quot;). </span>
<span class="sd">                &quot;down&quot;: Download contents of current remote directory to local destination.</span>
<span class="sd">                &quot;up&quot;: Upload contents of local destination to current remote directory.</span>
<span class="sd">                &quot;both&quot;: First synchronize &quot;down&quot;, then synchronize &quot;up&quot;.</span>
<span class="sd">            progress: Show a progress bar.</span>
<span class="sd">            batch_size: Number of files passed to each download call.</span>
<span class="sd">            replace_local: By default existing files are skipped, if this is enabled, existing files are deleted and refetched.</span>
<span class="sd">            refresh_cache: Recompute file index of remote directory, can be extremely slow. Disabled by default.</span>
<span class="sd">            **kwargs: Passed to IOHandler.download.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">           A list of paths to the local paths that have been synchronized, not including existing files if ``replace_local=False``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">local_destination</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected str or None, got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">local_destination</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">local_destination</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cur_remote_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cur_remote_dir</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_root</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attempted to synchronize root of remote, but `</span><span class="si">{</span><span class="n">allow_root</span><span class="si">=}</span><span class="s1">`!&#39;</span><span class="p">)</span>
                <span class="n">local_destination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">local_destination</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">(),</span> <span class="n">cur_remote_dir</span><span class="p">)</span>
        <span class="n">local_destination</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">local_destination</span><span class="p">))))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">local_destination</span><span class="p">)</span> <span class="o">==</span> <span class="n">local_destination</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_root</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attempted to synchronize root of local, but </span><span class="si">{</span><span class="n">allow_root</span><span class="si">=}</span><span class="s1">!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_destination</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">local_destination</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_file_index</span><span class="p">(</span><span class="n">override</span><span class="o">=</span><span class="n">refresh_cache</span><span class="p">)</span>
        <span class="n">down_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;down&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">]:</span>
            <span class="n">down_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">()]</span>
            <span class="n">ldest</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_destination</span><span class="p">,</span> <span class="o">*</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">down_files</span><span class="p">]</span>
            <span class="n">ldest</span><span class="p">,</span> <span class="n">down_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">([(</span><span class="n">l</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ldest</span><span class="p">,</span> <span class="n">down_files</span><span class="p">)</span> <span class="k">if</span> <span class="n">replace_local</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">l</span><span class="p">)]))))</span> <span class="ow">or</span> <span class="p">[[],[]]</span>
            <span class="n">down_files</span> <span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
            <span class="n">ldir</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="k">for</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">ldest</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">bi</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">down_files</span><span class="p">)</span><span class="o">//</span><span class="n">batch_size</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Synchronizing down: (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">()</span><span class="si">}</span><span class="s2">) ==&gt; (</span><span class="si">{</span><span class="n">local_destination</span><span class="si">}</span><span class="s2">) ...&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="n">unit_scale</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">progress</span><span class="p">,</span> <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">bs</span><span class="p">,</span> <span class="n">be</span> <span class="o">=</span> <span class="n">bi</span><span class="o">*</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">min</span><span class="p">((</span><span class="n">bi</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">down_files</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">replace_local</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ld</span> <span class="ow">in</span> <span class="n">ldest</span><span class="p">[</span><span class="n">bs</span><span class="p">:</span><span class="n">be</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ld</span><span class="p">):</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ld</span><span class="p">)</span>
                <span class="n">lres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">down_files</span><span class="p">[</span><span class="n">bs</span><span class="p">:</span><span class="n">be</span><span class="p">],</span> <span class="n">ldir</span><span class="p">[</span><span class="n">bs</span><span class="p">:</span><span class="n">be</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lres</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">lres</span> <span class="o">=</span> <span class="p">[</span><span class="n">lres</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lres</span><span class="p">,</span> <span class="n">ldest</span><span class="p">[</span><span class="n">bs</span><span class="p">:</span><span class="n">be</span><span class="p">],</span> <span class="n">down_files</span><span class="p">[</span><span class="n">bs</span><span class="p">:</span><span class="n">be</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unexpected download location for </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">, expected </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">, but got </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s1">?!&#39;</span><span class="p">)</span>
        <span class="n">up_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;up&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">]:</span>
            <span class="n">up_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lls</span><span class="p">(</span><span class="n">local_destination</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">up_files</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unexpected return value: </span><span class="si">{</span><span class="n">up_files</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">skippers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">down_files</span><span class="p">])</span>
            <span class="n">up_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">up_files</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skippers</span><span class="p">]</span>
            <span class="n">rdest</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">()</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">up_files</span><span class="p">]</span>
            <span class="n">rdir</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">rdest</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">bi</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">down_files</span><span class="p">)</span><span class="o">//</span><span class="n">batch_size</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Synchronizing up: (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">()</span><span class="si">}</span><span class="s2">) ==&gt; (</span><span class="si">{</span><span class="n">local_destination</span><span class="si">}</span><span class="s2">) ...&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="n">unit_scale</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">progress</span><span class="p">,</span> <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">bs</span><span class="p">,</span> <span class="n">be</span> <span class="o">=</span> <span class="n">bi</span><span class="o">*</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">min</span><span class="p">((</span><span class="n">bi</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">down_files</span><span class="p">))</span>
                <span class="n">rres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="n">up_files</span><span class="p">[</span><span class="n">bs</span><span class="p">:</span><span class="n">be</span><span class="p">],</span> <span class="n">rdir</span><span class="p">[</span><span class="n">bs</span><span class="p">:</span><span class="n">be</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rres</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">rres</span> <span class="o">=</span> <span class="p">[</span><span class="n">rres</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rres</span><span class="p">,</span> <span class="n">rdest</span><span class="p">[</span><span class="n">bs</span><span class="p">:</span><span class="n">be</span><span class="p">],</span> <span class="n">up_files</span><span class="p">[</span><span class="n">bs</span><span class="p">:</span><span class="n">be</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unexpected upload location for </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">, expected </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">, but got </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s1">?!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">down_files</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">up_files</span><span class="p">)))</span></div>

    
<div class="viewcode-block" id="IOHandler.get_file_index">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.IOHandler.get_file_index">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_file_index</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">skip</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
            <span class="n">nmax</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">override</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
            <span class="n">store</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">pattern</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a list of files in the current remote directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            skip: The number of files to skip.</span>
<span class="sd">            nmax: The maximum number of files to include.</span>
<span class="sd">            override: If True, the file index will be overridden if it already exists.</span>
<span class="sd">            store: If True, the file index will be stored on the remote directory.</span>
<span class="sd">            pattern: A regular expression pattern to filter the file names by, e.g. &quot;\\.txt$&quot; to only include files with the &quot;.txt&quot; extension.</span>
<span class="sd">        Returns:</span>
<span class="sd">           A list of files in the current remote directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">override</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">store</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;override cannot be &#39;True&#39; if store is &#39;False&#39;!&quot;</span><span class="p">)</span>
        <span class="c1"># Check if file index exists</span>
        <span class="n">file_index_exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;.folder_index.txt&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_index_exists</span><span class="p">:</span>
            <span class="c1"># Backwards compatibility check for folder index with old naming convention (non-hidden)</span>
            <span class="n">bc_file_index_exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;folder_index.txt&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bc_file_index_exists</span><span class="p">:</span>
                <span class="n">bc_file_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s1">&#39;glob -f du -sh *folder_index.txt | sort -hr | cut -f 2 | head -n 1&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">bc_file_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">bc_file_index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bc_file_index</span> <span class="o">:=</span> <span class="n">bc_file_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)):</span>
                    <span class="n">main_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Deprecated folder index detected, but failed to rename!&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mv &quot;</span><span class="si">{</span><span class="n">bc_file_index</span><span class="si">}</span><span class="s1">&quot; .folder_index.txt&#39;</span><span class="p">)</span>
                    <span class="n">file_index_exists</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">main_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Detected deprecated folder index </span><span class="si">{</span><span class="n">bc_file_index</span><span class="si">}</span><span class="s1"> and renamed to .folder_index.txt in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">main_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Folder index does not exist in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># If override is True, delete the file index if it exists</span>
        <span class="k">if</span> <span class="n">override</span> <span class="ow">and</span> <span class="n">file_index_exists</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s2">&quot;rm .folder_index.txt&quot;</span><span class="p">)</span>
            <span class="c1"># Now the file index does not exist (duh)</span>
            <span class="n">file_index_exists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># If the file index does not exist, create it</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_index_exists</span><span class="p">:</span>
            <span class="n">main_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating folder index...&quot;</span><span class="p">)</span>
            <span class="c1"># Traverse the remote directory and write the file index to a file</span>
            <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">local_index_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">(),</span> <span class="s2">&quot;.folder_index.txt&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_index_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Store the file index on the remote if &#39;store&#39; is True, otherwise delete it</span>
            <span class="k">if</span> <span class="n">store</span><span class="p">:</span>
                <span class="c1"># Self has an implicit reference to the local working directory, however the scripts does not necessarily have the same working directory</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="n">local_index_path</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">local_index_path</span><span class="p">)</span>
        
        <span class="c1"># Download the file index if &#39;store&#39; is True or it already exists on the remote, otherwise read it from the local directory</span>
        <span class="k">if</span> <span class="n">store</span> <span class="ow">or</span> <span class="n">file_index_exists</span><span class="p">:</span>
            <span class="n">file_index_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">&quot;.folder_index.txt&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_index_path</span> <span class="o">=</span> <span class="n">local_index_path</span>
        <span class="c1"># Read the file index</span>
        <span class="n">file_index</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_index_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skip</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">nmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">skip</span> <span class="o">+</span> <span class="n">nmax</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="s2">&quot;folder_index.txt&quot;</span> <span class="o">==</span> <span class="n">line</span><span class="p">[:</span><span class="mi">17</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">pattern</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">file_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="c1"># Delete the file index if &#39;store&#39; is True, otherwise return the path to the file index</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">store</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_index_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">file_index</span></div>

    
<div class="viewcode-block" id="IOHandler.cache_file_index">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.IOHandler.cache_file_index">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cache_file_index</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">skip</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
            <span class="n">nmax</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">override</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_file_index</span><span class="p">(</span><span class="n">skip</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span> <span class="n">override</span><span class="p">)</span></div>


<div class="viewcode-block" id="IOHandler.clean">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.IOHandler.clean">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_confirmation</span><span class="p">:</span>
            <span class="c1"># Ask for confirmation</span>
            <span class="n">confirmation</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Are you sure you want to delete all files in the current directory </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">()</span><span class="si">}</span><span class="s2">? (y/n)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">confirmation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                <span class="n">main_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Aborted&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="n">main_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cleaning up...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">()):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">delete_file_or_dir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">main_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while deleting </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">main_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error while cleaning local backend directory!&quot;</span><span class="p">)</span>
            <span class="n">files_in_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">files_in_dir</span><span class="p">:</span>
                <span class="n">n_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files_in_dir</span><span class="p">)</span>
                <span class="n">main_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n_files</span><span class="si">}</span><span class="s2"> files in local directory (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lpwd</span><span class="p">()</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n_files</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">main_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">files_in_dir</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">...&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">main_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">files_in_dir</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">e</span></div>
</div>


<div class="viewcode-block" id="RemotePathIterator">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.RemotePathIterator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RemotePathIterator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Buffered iterator for streaming many remote files efficiently.</span>

<span class="sd">    Downloads are performed in a background thread and yielded as</span>
<span class="sd">    ``(local_path, remote_path)`` tuples for consumption by the caller.</span>

<span class="sd">    Args:</span>
<span class="sd">        io_handler: Active :py:class:`pyremotedata.implicit_mount.IOHandler` used for all transfers.</span>
<span class="sd">        batch_size: Files to download per batch. Larger batches can be</span>
<span class="sd">            more efficient but use more memory.</span>
<span class="sd">        batch_parallel: Parallel transfers per batch. Tune for fairness</span>
<span class="sd">            and server limits.</span>
<span class="sd">        max_queued_batches: Number of prefetched batches to keep queued.</span>
<span class="sd">            Higher values smooth throughput but require more local storage.</span>
<span class="sd">        n_local_files: Maximum number of local files to keep before</span>
<span class="sd">            deleting consumed files. Must exceed</span>
<span class="sd">            ``batch_size * max_queued_batches`` (2x recommended).</span>
<span class="sd">        clear_local: If True, delete consumed files to free space.</span>
<span class="sd">        retry_base_delay: Initial backoff (seconds) for single-item retry.</span>
<span class="sd">        retry_max_delay: Maximum backoff (seconds) per retry step.</span>
<span class="sd">        retry_timeout: Per-file hard timeout (seconds) before raising.</span>
<span class="sd">        **kwargs: Forwarded to ``IOHandler.get_file_index`` to build the file</span>
<span class="sd">            index. Set ``store=False`` for read-only remotes (slower on first</span>
<span class="sd">            run). If ``store=False``, ``override`` must also be False.</span>

<span class="sd">    Yields:</span>
<span class="sd">       `(local_path, remote_path)`: for each downloaded file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">io_handler</span> <span class="p">:</span> <span class="s2">&quot;IOHandler&quot;</span><span class="p">,</span>
            <span class="n">batch_size</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
            <span class="n">batch_parallel</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">max_queued_batches</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">n_local_files</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="mi">64</span><span class="p">,</span>
            <span class="n">clear_local</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">retry_base_delay</span> <span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">retry_max_delay</span> <span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span>
            <span class="n">retry_timeout</span> <span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">120.0</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io_handler</span> <span class="o">=</span> <span class="n">io_handler</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">io_handler</span><span class="o">.</span><span class="n">pwd</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">io_handler</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io_handler</span><span class="o">.</span><span class="n">get_file_index</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">main_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using cached file index. [</span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1">] will be ignored.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io_handler</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">io_handler</span><span class="o">.</span><span class="n">pwd</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span><span class="p">)</span> <span class="c1"># Ensure locality</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io_handler</span><span class="o">.</span><span class="n">lpwd</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_parallel</span> <span class="o">=</span> <span class="n">batch_parallel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_queued_batches</span> <span class="o">=</span> <span class="n">max_queued_batches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_local_files</span> <span class="o">=</span> <span class="n">n_local_files</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_local_files</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
            <span class="n">main_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_local_files (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_local_files</span><span class="si">}</span><span class="s2">) is less than batch_size (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">). This may cause files to be deleted before they are consumed. Consider increasing n_local_files. Recommended value: </span><span class="si">{</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">max_queued_batches</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">download_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_requested</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">not_cleaned</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_local</span> <span class="o">=</span> <span class="n">clear_local</span>

        <span class="c1"># State variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_batch_consumed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consumed_files</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Retry/backoff configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retry_base_delay</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">retry_base_delay</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retry_max_delay</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">retry_max_delay</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retry_timeout</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">retry_timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_error</span> <span class="p">:</span> <span class="ne">BaseException</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># set if a file ultimately times out</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span><span class="p">)</span>

<div class="viewcode-block" id="RemotePathIterator.shuffle">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.RemotePathIterator.shuffle">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shuffle the internal list of remote paths in-place.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If called while iterating.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot shuffle while iterating.&quot;</span><span class="p">)</span>
        <span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span><span class="p">)</span></div>


<div class="viewcode-block" id="RemotePathIterator.subset">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.RemotePathIterator.subset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span> <span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Restrict the iterator to a subset of indices (in-place).</span>

<span class="sd">        Args:</span>
<span class="sd">            indices: Indices to keep. Accepts a list, a single int,</span>
<span class="sd">                or a slice.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If called while iterating.</span>
<span class="sd">            TypeError: If ``indices`` has an unsupported type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot subset while iterating.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expected `indices` to be a single or a list of indices (int, or list[int]), or a slice, but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="RemotePathIterator.split">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.RemotePathIterator.split">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">proportion</span> <span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">indices</span> <span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;RemotePathIterator&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Split into multiple iterators that share the same backend.</span>

<span class="sd">        Either ``proportion`` or ``indices`` must be provided (exclusively).</span>
<span class="sd">        The resulting iterators must not be used in parallel.</span>

<span class="sd">        Args:</span>
<span class="sd">            proportion: Proportions used to</span>
<span class="sd">                allocate items to splits. Will be normalized if needed.</span>
<span class="sd">            indices: Explicit index lists for</span>
<span class="sd">                each split.</span>

<span class="sd">        Returns:</span>
<span class="sd">           Independent iterators over disjoint</span>
<span class="sd">            subsets of the original paths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot split while iterating.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proportion</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either proportion or indices must be specified.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proportion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only one of proportion or indices must be specified.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">proportion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proportion</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;proportion must be a list.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">proportion</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;All proportions must be numeric (int or float).&quot;</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">proportion</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">total</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Sum of proportions must be &gt; 0.&quot;</span><span class="p">)</span>
            <span class="n">proportion</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">/</span> <span class="n">total</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">proportion</span><span class="p">]</span>
            <span class="n">allocation</span> <span class="o">=</span> <span class="n">choices</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proportion</span><span class="p">))),</span> <span class="n">weights</span><span class="o">=</span><span class="n">proportion</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span><span class="p">))</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proportion</span><span class="p">))]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">allocation</span><span class="p">):</span>
                <span class="n">indices</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;indices must be a list.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;indices must be a list of lists.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;indices must be a list of lists of ints.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">any</span><span class="p">([</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;indices must be a list of lists of ints in the range [0, len(remote_paths)).&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All indices must be non-empty.&quot;</span><span class="p">)</span>

        <span class="n">iterators</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="n">this</span> <span class="o">=</span> <span class="n">RemotePathIterator</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">io_handler</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">batch_parallel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_parallel</span><span class="p">,</span>
                <span class="n">max_queued_batches</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_queued_batches</span><span class="p">,</span>
                <span class="n">n_local_files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_local_files</span>
            <span class="p">)</span>
            <span class="n">this</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">iterators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">iterators</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_download_batch_with_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span> <span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="n">attempt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry_base_delay</span>
        <span class="n">last_exc</span> <span class="p">:</span> <span class="ne">BaseException</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">local_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io_handler</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_parallel</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_paths</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">local_paths</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloader returned invalid result length (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">local_paths</span><span class="p">)</span><span class="si">}</span><span class="s2">) for batch of size </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">local_paths</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">last_exc</span> <span class="o">=</span> <span class="n">e</span>
                <span class="n">attempt</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
                <span class="n">remaining</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry_timeout</span> <span class="o">-</span> <span class="n">elapsed</span>
                <span class="k">if</span> <span class="n">remaining</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">main_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch download timed out after </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s and </span><span class="si">{</span><span class="n">attempt</span><span class="si">}</span><span class="s2"> attempt(s).&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timed out downloading batch of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span><span class="si">}</span><span class="s2"> items&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
                <span class="n">wait</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry_max_delay</span><span class="p">,</span> <span class="n">remaining</span><span class="p">)</span>
                <span class="n">main_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Batch download failed (attempt </span><span class="si">{</span><span class="n">attempt</span><span class="si">}</span><span class="s2">); waiting </span><span class="si">{</span><span class="n">wait</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Time left ≈ </span><span class="si">{</span><span class="n">remaining</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s.&quot;</span>
                <span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span>
                <span class="n">delay</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">delay</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry_max_delay</span><span class="p">)</span>

<div class="viewcode-block" id="RemotePathIterator.download_files">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.RemotePathIterator.download_files">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">download_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">queued_batches</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_requested</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
    
            <span class="k">while</span> <span class="n">queued_batches</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_queued_batches</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_requested</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_batch_consumed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_batch_consumed</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">break</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
    
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_requested</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
    
            <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Invalid zero-length batch encountered! This is a bug.&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">local_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_batch_with_retry</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_error</span> <span class="o">=</span> <span class="n">e</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop_requested</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
    
            <span class="k">for</span> <span class="n">lp</span><span class="p">,</span> <span class="n">rp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">local_paths</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">download_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">lp</span><span class="p">,</span> <span class="n">rp</span><span class="p">))</span>
    
            <span class="n">queued_batches</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="RemotePathIterator.start_download_queue">
<a class="viewcode-back" href="../../api/implicit_mount.html#pyremotedata.implicit_mount.RemotePathIterator.start_download_queue">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start_download_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start the background thread that performs batch downloads.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">download_files</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an iterator that yields ``(local_path, remote_path)`` pairs.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">not_cleaned</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stop_requested</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">not_cleaned</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_error</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_download_queue</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_paths</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_requested</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="c1"># process delete queue</span>
                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_local</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_queue</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_local_files</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">delete_file_or_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delete_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">())</span>
                    <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">main_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to remove file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># wait here until we either get an item or detect a dead producer</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">stop_requested</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Download thread died before iteration finished.&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">next_item</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
                        <span class="k">break</span>  <span class="c1"># got an item</span>
                    <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                        <span class="c1"># producer may just be slow; only error if the thread has died</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">stop_requested</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error</span>
                            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Download thread died before iteration finished.&quot;</span><span class="p">)</span>
                        <span class="c1"># else: keep polling this same loop iteration</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">consumed_files</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumed_files</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">consumed_files</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_batch_consumed</span> <span class="o">+=</span> <span class="mi">1</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">delete_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">next_item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">yield</span> <span class="n">next_item</span>
            
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop background work and remove temporary files if requested.</span>

<span class="sd">        Args:</span>
<span class="sd">            force: If True, cleanup even if already performed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_cleaned</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_requested</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">download_thread</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="n">main_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Download thread did not terminate within 1s; it may still be running.&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_local</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">download_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">delete_file_or_dir</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">main_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to remove file (</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_local</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s2">&quot;folder_index.txt&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">delete_file_or_dir</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">main_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to remove file: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                <span class="n">main_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Download queue is not empty. This should not happen.&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_queue</span><span class="o">.</span><span class="n">mutex</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">download_queue</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_local</span><span class="p">:</span>
                <span class="n">main_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Delete queue is not empty. This should not happen.&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_queue</span><span class="o">.</span><span class="n">mutex</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delete_queue</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">not_cleaned</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">main_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Already cleaned up&quot;</span><span class="p">)</span></div>


</code></pre></div>







  
  






                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  
  
  <div class="md-footer-meta md-typeset">
    
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-footer-copyright__highlight">
        &#169; Copyright 2024, Asger Svenning.
        
    </div>
  
    Created using
    <a href="https://www.sphinx-doc.org/" target="_blank" rel="noopener">Sphinx</a>
    8.1.3.
     and
    <a href="https://github.com/jbms/sphinx-immaterial/" target="_blank" rel="noopener">Sphinx-Immaterial</a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://github.com/asgersvenning/pyremotedata" target="_blank" rel="noopener" title="Source on GitHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/pyremotedata/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 404c11.1 0 20.1 9.1 20.1 20.3 0 11.3-9 20.4-20.1 20.4-11 0-20.1-9.2-20.1-20.4.1-11.3 9.1-20.3 20.1-20.3M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.7-142.6c-11.1 0-20.1-9.1-20.1-20.3.1-11.3 9-20.4 20.1-20.4 11 0 20.1 9.2 20.1 20.4s-9 20.3-20.1 20.3"/></svg>
    </a>
  
</div>
      
    </div>
    
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.expand", "navigation.sections", "navigation.top", "navigation.footer", "search.share", "search.suggest", "toc.follow", "toc.sticky", "content.tabs.link", "content.code.copy", "content.action.edit", "content.action.view", "content.tooltips", "announce.dismiss"], "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike", "staticVersions": null, "versionPath": null}}</script>
    
      
        <script src="../../_static/sphinx_immaterial_theme.32136f45f91ae6956.min.js?v=a7a9472a"></script>
    
  </body>
</html>